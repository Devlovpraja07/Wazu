<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>मेरी न्यूज़ ऐप</title> <!-- Your App Title -->

    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="News App"> <!-- Short name for iOS -->
    <meta name="theme-color" content="#3498db"> <!-- Customize status bar color -->

    <!-- Link to manifest file -->
    <!-- Ensure manifest.json is in the root directory -->
    <link rel="manifest" href="/manifest.json">

    <!-- Add apple touch icon (replace with your icon in /icons folder) -->
    <!-- Ensure you have an /icons folder with apple-touch-icon.png -->
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* General Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 15px;
        }

        h1 {
            color: #3498db;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        /* News List Styles */
        .news-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .news-item {
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }

        .news-item:hover {
            transform: translateY(-3px);
        }

        .news-item img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .news-item h3 {
            font-size: 1.2em;
            color: #34495e;
            margin: 0 0 5px 0;
        }

        .news-item p {
            font-size: 0.95em;
            color: #555;
            margin: 0 0 10px 0;
        }

        .news-item a {
            display: inline-block; /* or block */
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9em;
            align-self: flex-start; /* Align link to the left */
            transition: color 0.3s ease;
        }

        .news-item a:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Message/Error */
        .message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
            display: none; /* Hidden by default */
        }

        .message.show {
            display: block;
        }

         /* Update Notification */
        #update-notification {
             position: fixed;
             bottom: 15px;
             left: 15px;
             right: 15px;
             background-color: #f39c12;
             color: #fff;
             padding: 15px;
             border-radius: 8px;
             text-align: center;
             box-shadow: 0 4px 10px rgba(0,0,0,0.2);
             z-index: 1000;
             display: none; /* Hidden by default */
             cursor: pointer;
        }
         #update-notification:hover {
             background-color: #e67e22;
         }

    </style>
</head>
<body>

    <div class="container">
        <h1>ताज़ा खबरें</h1> <!-- Your App Title -->

        <div id="newsLoader" class="loader"></div>
        <div id="newsMessage" class="message">खबरें लोड हो रही हैं...</div> <!-- Initial message -->

        <ul id="newsList" class="news-list">
            <!-- News articles will be loaded here -->
        </ul>
    </div>

    <!-- Update Notification Bar -->
    <div id="update-notification" style="display: none;">
        ऐप अपडेट उपलब्ध है! नया संस्करण प्राप्त करने के लिए यहां टैप करें।
    </div>


    <script>
        // --- Firebase Configuration ---
        // Use the same configuration as your admin panel
        const firebaseConfig = {
            apiKey: "AIzaSyAY3hXmpCXJUVrBtOaosPY_tsse3sx-O5o", // Your Firebase API key
            authDomain: "nima-d4d7d.firebaseapp.com", // Your Auth Domain
            databaseURL: "https://nima-d4d7d-default-rtdb.asia-southeast1.firebasedatabase.app", // Your Database URL
            projectId: "nima-d4d7d", // Your Project ID
            storageBucket: "nima-d4d7d.firebasestorage.app", // Your Storage Bucket
            // appId: "your_web_app_id_here" // Add if you have a web app registered
        };

         // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- DOM Elements ---
        const newsList = document.getElementById('newsList');
        const newsLoader = document.getElementById('newsLoader');
        const newsMessage = document.getElementById('newsMessage');
        const updateNotification = document.getElementById('update-notification');


        // --- Utility Functions ---
        function showLoader() {
            newsLoader.style.display = 'block';
             newsMessage.style.display = 'none'; // Hide message when loading
        }

        function hideLoader() {
            newsLoader.style.display = 'none';
        }

        function showMessage(msg, isError = false) {
            newsMessage.textContent = msg;
            newsMessage.className = 'message show ' + (isError ? '' : 'success'); // Use default error style or success
            newsMessage.style.display = 'block';
             hideLoader(); // Hide loader if message is shown
             // No auto-hide for main news list messages, user should see the status
        }

        function clearMessage() {
             newsMessage.textContent = '';
             newsMessage.classList.remove('show');
             newsMessage.style.display = 'none';
        }


        // --- Fetch and Display News ---
        function fetchAndDisplayNews() {
            showLoader();
            clearMessage(); // Clear any previous messages

            const newsRef = database.ref('customNews');

            // Use .on('value') for real-time updates, or .once('value') for single load
            // .on('value') is better for a news feed
            newsRef.orderByChild('publishedAt').on('value', (snapshot) => {
                hideLoader();
                const news = snapshot.val();
                newsList.innerHTML = ''; // Clear current list

                if (news) {
                    // Convert object to array, sort by publishedAt descending (latest first)
                    const newsArray = Object.keys(news).map(key => ({ ...news[key], key }));
                    newsArray.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));

                    newsArray.forEach(article => {
                        const li = document.createElement('li');
                        li.classList.add('news-item');

                        // Add image if available
                        if (article.urlToImage) {
                            const img = document.createElement('img');
                            img.src = article.urlToImage;
                            img.alt = article.title || 'खबर की छवि';
                            li.appendChild(img);
                        }

                        // Add title
                        const title = document.createElement('h3');
                        title.textContent = article.title || 'शीर्षक उपलब्ध नहीं';
                        li.appendChild(title);

                        // Add description
                        const description = document.createElement('p');
                        description.textContent = article.description || 'विवरण उपलब्ध नहीं।';
                        li.appendChild(description);

                        // Add source link
                        if (article.url) {
                            const link = document.createElement('a');
                            link.href = article.url;
                            link.textContent = 'पूरी खबर पढ़ें';
                            link.target = '_blank'; // Open link in a new tab/browser
                            link.rel = 'noopener noreferrer'; // Security best practice
                            li.appendChild(link);
                        }

                        newsList.appendChild(li);
                    });
                } else {
                    showMessage('अभी कोई खबर उपलब्ध नहीं है।', false); // Info message
                }
            }, (error) => {
                hideLoader();
                console.error("खबरें लोड करने में त्रुटि:", error);
                showMessage('खबरें लोड करने में त्रुटि हुई: ' + error.message, true); // Error message
            });
        }

        // --- PWA Service Worker Registration ---
        window.addEventListener('load', () => {
          if ('serviceWorker' in navigator) {
              console.log('Registering service worker...');
            navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('Service Worker registered with scope:', registration.scope);

               // Listen for service worker updates
               registration.addEventListener('updatefound', () => {
                   // A new service worker is installing
                   const installingWorker = registration.installing;
                   if (installingWorker) {
                       console.log('New service worker installing');
                       installingWorker.addEventListener('statechange', () => {
                           if (installingWorker.state === 'installed') {
                               if (navigator.serviceWorker.controller) {
                                   // New content is available, show update notification
                                   console.log('New content is available, showing update prompt.');
                                   showUpdateNotification();
                               } else {
                                   // Content is cached for offline use (initial install)
                                   console.log('Content is cached for offline use.');
                               }
                           }
                       });
                   }
               });
                // Check if a new service worker is already waiting
               if (registration.waiting) {
                   console.log('New service worker already waiting.');
                   showUpdateNotification();
               }

            })
            .catch(error => {
              console.error('Service Worker registration failed:', error);
            });

             // Listen for controllerchange to know when a new service worker takes over
             navigator.serviceWorker.addEventListener('controllerchange', () => {
                 console.log('Controller changed, new service worker is active.');
                 // Optionally reload the page or notify the user that update is active
                 // window.location.reload(); // Auto-reload is one strategy, but can be jarring
             });


          } else {
              console.warn('Service Workers are not supported in this browser.');
          }
        });

        // --- Update Notification Functionality ---
        function showUpdateNotification() {
            updateNotification.style.display = 'block';
        }

        function hideUpdateNotification() {
             updateNotification.style.display = 'none';
        }

        // Handle update notification click
        updateNotification.addEventListener('click', () => {
            hideUpdateNotification();
            // Tell the waiting service worker to activate immediately
            if (navigator.serviceWorker.waiting) {
                navigator.serviceWorker.waiting.postMessage({ type: 'SKIP_WAITING' });
            }
            // After skipping waiting, the controllerchange event will fire,
            // or you can simply reload the page to use the new service worker.
             // A small delay can help ensure the message is processed
            setTimeout(() => {
                window.location.reload();
            }, 100); // Reload to pick up the new version
        });


         // --- Listen for Firebase App Settings Changes (e.g., API Key, Update Trigger) ---
         // This is how your app can react to changes made in the Admin Panel's App Updates or API Key tabs
         database.ref('appSettings').on('value', (snapshot) => {
             const appSettings = snapshot.val();
             console.log('App settings updated:', appSettings);

             // Example: React to lastUpdateTimestamp changing
             // The Admin Panel updates appSettings/lastUpdateTimestamp when "Trigger App Update" is clicked.
             // Your app can use this to know *when* to check for service worker updates.
             // However, the service worker registration already handles 'updatefound'.
             // A more direct use might be if you had dynamic config based on timestamp.

             // Example: Get the external API Key set by the admin
             if (appSettings && appSettings.externalNewsApiKey) {
                 const externalApiKey = appSettings.externalNewsApiKey;
                 console.log('External API Key available:', externalApiKey);
                 // TODO: Use this externalApiKey in your code to fetch news from an external source
                 // (This would involve fetching data from the external API using this key and combining
                 // it with the news from 'customNews' or displaying it separately).
             } else {
                 console.log('No external API Key set.');
             }

             // Example: Check for banned status (requires user authentication in your app)
             // If your app authenticates users, you could check database.ref('bannedUsers/' + userId).once('value', ...)
             // and ban the user client-side if the value is true. This requires knowing the logged-in userId.
         });


        // --- Initial Load ---
        fetchAndDisplayNews(); // Load news when the page loads

    </script>
</body>
</html>