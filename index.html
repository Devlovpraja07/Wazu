///tag///
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Community</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #0d6e6e;
            --secondary-color: #f0f0f0;
            --text-color: #333;
            --bg-color: #fff;
            --card-color: #f9f9f9;
            --footer-color: #0a5555;
            --border-color: #ddd;
            --input-bg: #fff;
            --modal-bg: #fff;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            --modal-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            --follow-btn-color: #007bff;
            --unfollow-btn-color: #6c757d;
        }

        .dark-mode {
            --primary-color: #0d6e6e;
            --secondary-color: #333;
            --text-color: #f0f0f0;
            --bg-color: #222;
            --card-color: #444;
            --footer-color: #0a3d3d;
            --border-color: #555;
            --input-bg: #333;
            --modal-bg: #2b2b2b;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            --modal-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            --follow-btn-color: #4da6ff;
            --unfollow-btn-color: #999;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .logo i {
            margin-right: 10px;
        }

        .dark-mode-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }

        .user-story {
            padding: 15px;
            background-color: var(--secondary-color);
            margin-bottom: 20px;
            overflow-x: auto;
            white-space: nowrap;
            display: flex; /* Use flex to ensure stories stay in one row */
            align-items: center;
            gap: 15px; /* Spacing between stories */
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .user-story::-webkit-scrollbar {
            display: none;
        }

        .story {
            display: inline-flex; /* Use inline-flex for vertical centering and horizontal spacing */
            flex-direction: column;
            align-items: center;
            width: 70px; /* Fixed width */
            flex-shrink: 0;
            text-align: center;
            cursor: pointer;
        }

        .story-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            margin-bottom: 5px;
            transition: transform 0.2s ease;
        }
        .story-avatar:hover {
            transform: scale(1.05);
        }
        .story.add-story .story-avatar {
            border-style: dashed;
            opacity: 0.7;
        }
        .story-avatar.seen {
            border-color: #888; /* Dim border for seen stories */
        }

        .story-username {
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-color);
            max-width: 100%; /* Ensure text doesn't overflow story width */
        }

        .post-container {
            padding: 0 15px;
            margin-bottom: 70px;
        }

        .post {
            background-color: var(--card-color);
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .post:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .post-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .post-header-info {
            flex-grow: 1;
        }
        .post-header-actions {
            margin-left: auto;
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            cursor: pointer; /* Indicate clickable for story */
        }

        .post-user {
            font-weight: bold;
            font-size: 14px;
            color: var(--text-color);
            cursor: pointer; /* Indicate clickable for profile */
        }

        .post-time {
            font-size: 12px;
            color: #888;
            margin-left: 5px;
        }

        .post-content {
            padding: 0 15px 10px;
            cursor: pointer;
        }

        .post-title {
            font-weight: bold;
            margin: 10px 0 5px;
            font-size: 16px;
            color: var(--text-color);
        }

        .post-text {
            font-size: 14px;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .post-image, .post-video {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .post-actions {
            display: flex;
            justify-content: space-around;
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }

        .post-action {
            display: flex;
            align-items: center;
            color: var(--text-color);
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .post-action:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
        }

        .follow-btn {
            background-color: var(--follow-btn-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }
        .follow-btn.unfollow {
            background-color: var(--unfollow-btn-color);
        }
        .follow-btn:hover {
            opacity: 0.9;
        }

        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--footer-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            color: white;
            text-decoration: none;
            text-align: center;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .nav-item i {
            display: block;
            font-size: 20px;
            margin-bottom: 3px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--modal-bg);
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--modal-shadow);
            transform: translateY(20px);
            opacity: 0;
            animation: fadeInModal 0.3s forwards ease-out;
        }

        .modal.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        @keyframes fadeInModal {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.2s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        .btn:hover {
            background-color: #0a5555;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .switch-form {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
        }

        .add-post-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: var(--shadow);
            z-index: 99;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .add-post-btn:hover {
            background-color: #0a5555;
            transform: scale(1.05);
        }

        .alert-message {
            background-color: #f44336;
            color: white;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        .alert-message.success {
            background-color: #4CAF50;
        }

        /* Profile Modal Specifics */
        .profile-header-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .profile-avatar-display {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            margin-bottom: 10px;
        }
        .profile-name {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-color);
        }
        .profile-email {
            font-size: 14px;
            color: #888;
        }
        .profile-edit-avatar-btn {
            margin-top: 10px;
            background-color: #0a5555;
            font-size: 12px;
            padding: 5px 10px;
        }
        /* User Profile Modal Specifics */
        .user-profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            font-size: 14px;
        }
        .user-profile-stat {
            text-align: center;
        }
        .user-profile-stat strong {
            display: block;
            font-size: 18px;
            color: var(--primary-color);
        }
        .user-profile-posts-container {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }
        .user-profile-posts-container .post {
            cursor: default; /* Posts in this section are not clickable for detail */
        }
        .user-profile-posts-container .post-content {
             cursor: default; /* Posts in this section are not clickable for detail */
        }


        .profile-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .profile-tab-btn {
            background: none;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #888;
            border-bottom: 2px solid transparent;
            transition: color 0.2s ease, border-bottom-color 0.2s ease;
        }
        .profile-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .profile-tab-content {
            display: none;
        }
        .profile-tab-content.active {
            display: block;
        }

        /* For full screen post modal */
        .post-detail-modal-body .post-header {
            border-bottom: none;
        }
        .post-detail-modal-body .post-image, .post-detail-modal-body .post-video {
            max-height: 500px;
        }

        /* Story Detail Modal */
        .modal.story-detail-modal .modal-content {
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            border-radius: 0;
            background-color: black;
            position: relative;
        }
        .modal.story-detail-modal .modal-body {
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            position: relative;
        }
        .story-detail-modal-body img, .story-detail-modal-body video {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            flex-shrink: 0;
        }
        .story-detail-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0));
            display: flex;
            align-items: center;
            color: white;
            z-index: 10;
        }
        .story-detail-header .story-avatar {
            width: 40px;
            height: 40px;
            border: 2px solid white;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .story-detail-header .story-info {
            flex-grow: 1;
        }
        .story-detail-header .story-username-display {
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        .story-detail-header .story-time-display {
            font-size: 12px;
            color: #ccc;
            margin-left: 5px;
        }
        .story-detail-header .follow-btn {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            padding: 5px 10px;
            font-size: 12px;
        }
        .story-detail-header .follow-btn.unfollow {
            background-color: #6c757d;
        }
        .story-detail-modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 20;
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            header {
                padding: 10px 15px;
            }
            .logo {
                font-size: 20px;
            }
            .user-story {
                padding: 10px;
                gap: 10px;
            }
            .story {
                width: 60px;
            }
            .story-avatar {
                width: 50px;
                height: 50px;
            }
            .post-container {
                padding: 0 10px;
            }
            .post-header {
                padding: 8px 10px;
            }
            .post-content {
                padding: 0 10px 8px;
            }
            .post-actions {
                padding: 8px 10px;
                font-size: 12px;
            }
            .post-action i {
                font-size: 16px;
            }
            .footer-nav {
                padding: 8px 0;
            }
            .nav-item {
                font-size: 10px;
            }
            .nav-item i {
                font-size: 18px;
            }
            .add-post-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 70px;
                right: 15px;
            }
            .modal-content {
                width: 95%;
            }
            .modal-body {
                padding: 15px;
            }
            /* Story detail modal full screen */
            .modal.story-detail-modal .modal-content {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-mosque"></i> Islamic Community
        </div>
        <button class="dark-mode-toggle" id="darkModeToggle">
            <i class="fas fa-moon"></i>
        </button>
    </header>

    <div class="user-story" id="storyContainer">
        <div class="story add-story" id="addStoryBtn">
            <img src="https://via.placeholder.com/60/ccc/fff?text=+" alt="Add Story" class="story-avatar">
            <div class="story-username">Add Story</div>
        </div>
        <!-- Dynamic Stories will be loaded here -->
        <p class="text-center" id="loadingStories" style="display: none; font-size: 12px; color: #888; flex-shrink: 0; padding: 0 10px;">Loading stories...</p>
    </div>

    <div class="post-container" id="postContainer">
        <!-- Posts will be loaded here from Firebase -->
        <p class="text-center" id="loadingPosts">Loading posts...</p>
    </div>

    <div class="add-post-btn" id="addPostBtn">
        <i class="fas fa-plus"></i>
    </div>

    <div class="footer-nav">
        <a href="#" class="nav-item">
            <i class="fas fa-home"></i>
            Home
        </a>
        <a href="#" class="nav-item">
            <i class="fas fa-quran"></i>
            Quran
        </a>
        <a href="#" class="nav-item">
            <i class="fas fa-pray"></i>
            Prayer
        </a>
        <a href="#" class="nav-item" id="profileNavBtn">
            <i class="fas fa-user"></i>
            Profile
        </a>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Login</h3>
                <button class="modal-close" id="closeLoginModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-message" id="loginAlert"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-block" id="loginSubmitBtn">Login</button>
                </form>
                <div class="text-center mt-3">
                    Don't have an account? <span class="switch-form" id="showRegister">Register</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Register</h3>
                <button class="modal-close" id="closeRegisterModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-message" id="registerAlert"></div>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerName">Full Name</label>
                        <input type="text" id="registerName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">Confirm Password</label>
                        <input type="password" id="registerConfirmPassword" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-block" id="registerSubmitBtn">Register</button>
                </form>
                <div class="text-center mt-3">
                    Already have an account? <span class="switch-form" id="showLogin">Login</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Post Modal -->
    <div class="modal" id="addPostModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Post</h3>
                <button class="modal-close" id="closeAddPostModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-message" id="addPostAlert"></div>
                <form id="addPostForm">
                    <div class="form-group">
                        <label for="postTitle">Title</label>
                        <input type="text" id="postTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="postContent">Content</label>
                        <textarea id="postContent" class="form-control" rows="5" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="postMedia">Image/Video (Optional)</label>
                        <input type="file" id="postMedia" class="form-control" accept="image/*,video/mp4,video/quicktime">
                    </div>
                    <button type="submit" class="btn btn-block" id="publishPostBtn">Publish Post</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Story Modal -->
    <div class="modal" id="addStoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Story</h3>
                <button class="modal-close" id="closeAddStoryModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-message" id="addStoryAlert"></div>
                <form id="addStoryForm">
                    <div class="form-group">
                        <label for="storyMedia">Story Image/Video</label>
                        <input type="file" id="storyMedia" class="form-control" accept="image/*,video/mp4,video/quicktime" required>
                    </div>
                    <button type="submit" class="btn btn-block" id="publishStoryBtn">Publish Story</button>
                </form>
            </div>
        </div>
    </div>


    <!-- Post Detail Modal (Full screen view) -->
    <div class="modal" id="postDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailPostTitle"></h3>
                <button class="modal-close" id="closePostDetailModal">&times;</button>
            </div>
            <div class="modal-body post-detail-modal-body" id="postDetailContent">
                <!-- Post content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Story Detail Modal (Full screen view) -->
    <div class="modal story-detail-modal" id="storyDetailModal">
        <div class="modal-content">
            <div class="modal-body story-detail-modal-body" id="storyDetailContent">
                <!-- Story content will be loaded here dynamically -->
            </div>
            <!-- The close button is now outside the dynamically generated content, always present -->
            <button class="story-detail-modal-close-btn" id="closeStoryDetailModalButton">&times;</button>
        </div>
    </div>


    <!-- Profile Modal (for current user to edit their own profile) -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Your Profile</h3>
                <button class="modal-close" id="closeProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-message" id="profileAlert"></div>
                
                <div class="profile-header-section">
                    <img src="https://randomuser.me/api/portraits/men/100.jpg" alt="Profile Picture" class="profile-avatar-display" id="profileAvatarDisplay">
                    <div class="profile-name" id="profileDisplayName"></div>
                    <div class="profile-email" id="profileEmail"></div>
                    <input type="file" id="profileImageUpload" accept="image/*" style="display: none;">
                    <button class="btn profile-edit-avatar-btn" id="changeAvatarBtn">Change Profile Picture</button>
                </div>

                <div class="profile-tabs">
                    <button class="profile-tab-btn active" data-tab="edit-profile-tab">Edit Profile</button>
                    <button class="profile-tab-btn" data-tab="my-posts-tab">My Posts</button>
                </div>

                <div id="edit-profile-tab" class="profile-tab-content active">
                    <form id="editProfileForm">
                        <div class="form-group">
                            <label for="editDisplayName">Display Name</label>
                            <input type="text" id="editDisplayName" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-block" id="updateProfileBtn">Update Profile</button>
                    </form>
                    <button class="btn btn-block mt-3" id="logoutBtn">Logout</button>
                </div>

                <div id="my-posts-tab" class="profile-tab-content">
                    <div id="myPostsContainer">
                        <p class="text-center" id="loadingMyPosts">Loading your posts...</p>
                        <!-- User's posts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal (for viewing other users' profiles) -->
    <div class="modal" id="userProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userProfileName"></h3>
                <button class="modal-close" id="closeUserProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-message" id="userProfileAlert"></div>
                
                <div class="profile-header-section">
                    <img src="https://randomuser.me/api/portraits/men/100.jpg" alt="Profile Picture" class="profile-avatar-display" id="userProfileAvatar">
                    <div class="profile-name" id="userProfileDisplayName"></div>
                    <div class="profile-email" id="userProfileEmail"></div>
                    <div class="user-profile-stats">
                        <div class="user-profile-stat">
                            <strong id="userProfilePostsCount">0</strong> Posts
                        </div>
                        <div class="user-profile-stat">
                            <strong id="userProfileFollowersCount">0</strong> Followers
                        </div>
                        <div class="user-profile-stat">
                            <strong id="userProfileFollowingCount">0</strong> Following
                        </div>
                    </div>
                    <button class="btn follow-btn mt-3" id="userProfileFollowBtn" style="display: none;"></button>
                </div>

                <div class="user-profile-posts-container" id="userProfilePostsContainer">
                    <p class="text-center" id="loadingUserProfilePosts">Loading posts...</p>
                    <!-- Other user's posts will be loaded here -->
                </div>
            </div>
        </div>
    </div>


    <!-- Edit Post Modal -->
    <div class="modal" id="editPostModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Post</h3>
                <button class="modal-close" id="closeEditPostModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-message" id="editPostAlert"></div>
                <form id="editPostForm">
                    <input type="hidden" id="editPostId">
                    <div class="form-group">
                        <label for="editPostTitle">Title</label>
                        <input type="text" id="editPostTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editPostContent">Content</label>
                        <textarea id="editPostContent" class="form-control" rows="5" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editPostMedia">New Image/Video (Optional)</label>
                        <input type="file" id="editPostMedia" class="form-control" accept="image/*,video/mp4,video/quicktime">
                        <p class="mt-3" id="currentPostMediaText"></p>
                    </div>
                    <button type="submit" class="btn btn-block" id="saveEditPostBtn">Save Changes</button>
                    <button type="button" class="btn btn-block mt-3" style="background-color: #f44336;" id="deletePostBtn">Delete Post</button>
                </form>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase Configuration (from your provided details)
            const firebaseConfig = {
                apiKey: "AIzaSyD6EXA7D77rQDQEohB52BvTYimFeTEaAho",
                authDomain: "rn-gfx-tool.firebaseapp.com",
                databaseURL: "https://rn-gfx-tool-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "rn-gfx-tool",
                storageBucket: "rn-gfx-tool.firebasestorage.app",
                messagingSenderId: "163149358541",
                appId: "1:163149358541:android:2ef6d22fcd23e77ee09084"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);

            const auth = firebase.auth();
            const database = firebase.database();
            const CLOUDINARY_CLOUD_NAME = 'dhw1xn7ko'; // Your provided Cloud Name
            const CLOUDINARY_UPLOAD_PRESET = 'Raazbhai'; // Your provided Unsigned Preset for ALL uploads
            const CLOUDINARY_BASE_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}`;

            let currentUser = null; // To store the current logged-in user object
            let followingList = {}; // To store UIDs of users current user is following

            // --- UI Elements ---
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;

            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            const addPostModal = document.getElementById('addPostModal');
            const addStoryModal = document.getElementById('addStoryModal');
            const postDetailModal = document.getElementById('postDetailModal');
            const storyDetailModal = document.getElementById('storyDetailModal');
            const profileModal = document.getElementById('profileModal'); // Current user's profile
            const userProfileModal = document.getElementById('userProfileModal'); // Other user's profile
            const editPostModal = document.getElementById('editPostModal');

            const profileNavBtn = document.getElementById('profileNavBtn');

            const closeLoginModal = document.getElementById('closeLoginModal');
            const closeRegisterModal = document.getElementById('closeRegisterModal');
            const closeAddPostModal = document.getElementById('closeAddPostModal');
            const closeAddStoryModal = document.getElementById('closeAddStoryModal');
            const closePostDetailModal = document.getElementById('closePostDetailModal');
            const closeStoryDetailModalButton = document.getElementById('closeStoryDetailModalButton'); 
            const closeProfileModal = document.getElementById('closeProfileModal');
            const closeUserProfileModal = document.getElementById('closeUserProfileModal'); // New close button for other user's profile
            const closeEditPostModal = document.getElementById('closeEditPostModal');


            const showRegister = document.getElementById('showRegister');
            const showLogin = document.getElementById('showLogin');

            const addPostBtn = document.getElementById('addPostBtn');
            const addStoryBtn = document.getElementById('addStoryBtn'); // New Add Story button
            const storyContainer = document.getElementById('storyContainer');
            const loadingStories = document.getElementById('loadingStories');

            const postContainer = document.getElementById('postContainer');
            const loadingPosts = document.getElementById('loadingPosts');

            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const addPostForm = document.getElementById('addPostForm');
            const addStoryForm = document.getElementById('addStoryForm');
            const editProfileForm = document.getElementById('editProfileForm');
            const editPostForm = document.getElementById('editPostForm');

            const loginAlert = document.getElementById('loginAlert');
            const registerAlert = document.getElementById('registerAlert');
            const addPostAlert = document.getElementById('addPostAlert');
            const addStoryAlert = document.getElementById('addStoryAlert');
            const profileAlert = document.getElementById('profileAlert');
            const userProfileAlert = document.getElementById('userProfileAlert'); // New alert for user profile modal
            const editPostAlert = document.getElementById('editPostAlert');

            const loginSubmitBtn = document.getElementById('loginSubmitBtn');
            const registerSubmitBtn = document.getElementById('registerSubmitBtn');
            const publishPostBtn = document.getElementById('publishPostBtn');
            const publishStoryBtn = document.getElementById('publishStoryBtn');
            const updateProfileBtn = document.getElementById('updateProfileBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const saveEditPostBtn = document.getElementById('saveEditPostBtn');
            const deletePostBtn = document.getElementById('deletePostBtn');

            const profileAvatarDisplay = document.getElementById('profileAvatarDisplay');
            const profileDisplayName = document.getElementById('profileDisplayName');
            const profileEmail = document.getElementById('profileEmail');
            const profileImageUpload = document.getElementById('profileImageUpload');
            const changeAvatarBtn = document.getElementById('changeAvatarBtn');
            const editDisplayNameInput = document.getElementById('editDisplayName');
            const myPostsContainer = document.getElementById('myPostsContainer');
            const loadingMyPosts = document.getElementById('loadingMyPosts');

            const userProfileName = document.getElementById('userProfileName');
            const userProfileAvatar = document.getElementById('userProfileAvatar');
            const userProfileDisplayName = document.getElementById('userProfileDisplayName');
            const userProfileEmail = document.getElementById('userProfileEmail');
            const userProfilePostsCount = document.getElementById('userProfilePostsCount');
            const userProfileFollowersCount = document.getElementById('userProfileFollowersCount');
            const userProfileFollowingCount = document.getElementById('userProfileFollowingCount');
            const userProfileFollowBtn = document.getElementById('userProfileFollowBtn');
            const userProfilePostsContainer = document.getElementById('userProfilePostsContainer');
            const loadingUserProfilePosts = document.getElementById('loadingUserProfilePosts');


            const profileTabButtons = document.querySelectorAll('.profile-tab-btn');
            const profileTabContents = document.querySelectorAll('.profile-tab-content');

            // --- Utility Functions ---
            function displayAlert(element, message, type = 'error') {
                element.textContent = message;
                element.classList.remove('error', 'success');
                element.classList.add(type);
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                    element.textContent = '';
                }, 5000);
            }

            function timeAgo(timestamp) {
                const now = Date.now();
                const seconds = Math.floor((now - timestamp) / 1000);

                if (seconds < 60) return `${seconds} seconds ago`;
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes} minutes ago`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours} hours ago`;
                const days = Math.floor(hours / 24);
                if (days < 30) return `${days} days ago`;
                const months = Math.floor(days / 30);
                if (months < 12) return `${months} months ago`;
                const years = Math.floor(months / 12);
                return `${years} years ago`;
            }

            function getDefaultAvatarUrl(uid) {
                let hash = 0;
                if (uid) { // Ensure UID is not null/undefined
                    for (let i = 0; i < uid.length; i++) {
                        hash = uid.charCodeAt(i) + ((hash << 5) - hash);
                    }
                }
                const gender = (hash % 2 === 0) ? 'men' : 'women';
                const index = Math.abs(hash % 100) + 1;
                return `https://randomuser.me/api/portraits/${gender}/${index}.jpg`;
            }

            // --- Dark Mode Toggle ---
            darkModeToggle.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                const icon = darkModeToggle.querySelector('i');
                if (body.classList.contains('dark-mode')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            });

            // --- Modal Handling ---
            function openModal(modal) {
                modal.style.display = 'flex';
                modal.classList.add('show');
            }

            function closeModal(modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
                const alertElement = modal.querySelector('.alert-message');
                if (alertElement) {
                    alertElement.style.display = 'none';
                    alertElement.textContent = '';
                }
            }

            closeLoginModal.addEventListener('click', () => closeModal(loginModal));
            closeRegisterModal.addEventListener('click', () => closeModal(registerModal));
            closeAddPostModal.addEventListener('click', () => closeModal(addPostModal));
            closeAddStoryModal.addEventListener('click', () => closeModal(addStoryModal));
            closePostDetailModal.addEventListener('click', () => closeModal(postDetailModal));
            closeStoryDetailModalButton.addEventListener('click', () => closeModal(storyDetailModal)); 
            closeProfileModal.addEventListener('click', () => closeModal(profileModal));
            closeUserProfileModal.addEventListener('click', () => closeModal(userProfileModal));
            closeEditPostModal.addEventListener('click', () => closeModal(editPostModal));


            showRegister.addEventListener('click', () => {
                closeModal(loginModal);
                openModal(registerModal);
            });

            showLogin.addEventListener('click', () => {
                closeModal(registerModal);
                openModal(loginModal);
            });

            addPostBtn.addEventListener('click', () => {
                if (currentUser) {
                    openModal(addPostModal);
                } else {
                    openModal(loginModal);
                    displayAlert(loginAlert, 'Please login to create a post.');
                }
            });

            addStoryBtn.addEventListener('click', () => {
                if (currentUser) {
                    openModal(addStoryModal);
                } else {
                    openModal(loginModal);
                    displayAlert(loginAlert, 'Please login to add a story.');
                }
            });

            profileNavBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentUser) {
                    openModal(profileModal);
                    updateProfileModalUI(currentUser);
                    renderUserPosts(currentUser.uid); // Render own posts
                } else {
                    openModal(loginModal);
                    displayAlert(loginAlert, 'Please login to view your profile.');
                }
            });

            window.addEventListener('click', (e) => {
                if (e.target === loginModal) closeModal(loginModal);
                if (e.target === registerModal) closeModal(registerModal);
                if (e.target === addPostModal) closeModal(addPostModal);
                if (e.target === addStoryModal) closeModal(addStoryModal);
                if (e.target === postDetailModal) closeModal(postDetailModal);
                if (e.target === storyDetailModal) closeModal(storyDetailModal);
                if (e.target === profileModal) closeModal(profileModal);
                if (e.target === userProfileModal) closeModal(userProfileModal);
                if (e.target === editPostModal) closeModal(editPostModal);
            });

            // --- Firebase Authentication & User State ---
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    console.log('User logged in:', user.email, 'UID:', user.uid);

                    if (!user.displayName || !user.photoURL) {
                        const defaultName = user.email ? user.email.split('@')[0] : 'Guest User';
                        const defaultAvatar = getDefaultAvatarUrl(user.uid);
                        await user.updateProfile({
                            displayName: user.displayName || defaultName,
                            photoURL: user.photoURL || defaultAvatar
                        }).then(() => {
                            console.log('User profile updated with default values.');
                            currentUser = auth.currentUser;
                        }).catch(error => {
                            console.error('Error updating user profile:', error);
                        });
                    }
                    addPostBtn.style.display = 'flex';

                    // Fetch current user's following list in real-time
                    database.ref(`userFollowing/${user.uid}`).on('value', (snapshot) => {
                        followingList = {};
                        snapshot.forEach(child => {
                            followingList[child.key] = true;
                        });
                        console.log('Following list updated:', Object.keys(followingList));
                        fetchStories(); // Re-fetch stories to update visibility
                        fetchPosts(); // Re-render posts to update follow buttons
                    });

                    // Ensure user profile exists in Realtime Database for easier querying
                    database.ref('userProfiles/' + user.uid).once('value', (snapshot) => {
                        if (!snapshot.exists()) {
                            database.ref('userProfiles/' + user.uid).set({
                                email: user.email,
                                displayName: user.displayName || user.email.split('@')[0],
                                avatarUrl: user.photoURL || getDefaultAvatarUrl(user.uid),
                                createdAt: Date.now()
                            }).then(() => {
                                console.log('User profile created in RTDB.');
                            }).catch(error => {
                                console.error('Error creating user profile in RTDB:', error);
                            });
                        }
                    });

                } else {
                    console.log('User logged out');
                    addPostBtn.style.display = 'none';
                    followingList = {};
                    fetchStories(); // Re-fetch stories (will only show static add story button)
                    fetchPosts(); // Re-render posts (will remove follow buttons)
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginForm.loginEmail.value;
                const password = loginForm.loginPassword.value;

                loginSubmitBtn.disabled = true;
                displayAlert(loginAlert, 'Logging in...', 'success');

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    closeModal(loginModal);
                    displayAlert(loginAlert, 'Login successful!', 'success');
                    loginForm.reset();
                } catch (error) {
                    displayAlert(loginAlert, error.message);
                } finally {
                    loginSubmitBtn.disabled = false;
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = registerForm.registerName.value;
                const email = registerForm.registerEmail.value;
                const password = registerForm.registerPassword.value;
                const confirmPassword = registerForm.registerConfirmPassword.value;

                if (password !== confirmPassword) {
                    displayAlert(registerAlert, 'Passwords do not match!');
                    return;
                }

                registerSubmitBtn.disabled = true;
                displayAlert(registerAlert, 'Registering...', 'success');

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const uid = userCredential.user.uid;
                    const defaultAvatar = getDefaultAvatarUrl(uid);

                    await userCredential.user.updateProfile({
                        displayName: name,
                        photoURL: defaultAvatar
                    });

                    await database.ref('userProfiles/' + uid).set({
                        email: email,
                        displayName: name,
                        avatarUrl: defaultAvatar,
                        createdAt: Date.now()
                    });

                    closeModal(registerModal);
                    displayAlert(registerAlert, 'Registration successful! You are now logged in.', 'success');
                    registerForm.reset();
                } catch (error) {
                    displayAlert(registerAlert, error.message);
                } finally {
                    registerSubmitBtn.disabled = false;
                }
            });

            logoutBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        await auth.signOut();
                        closeModal(profileModal);
                        displayAlert(loginAlert, 'Logged out successfully!', 'success');
                    } catch (error) {
                        displayAlert(profileAlert, error.message);
                    }
                }
            });

            // --- Cloudinary Media Upload ---
            async function uploadMediaToCloudinary(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                try {
                    const resourceType = file.type.startsWith('video') ? 'video' : 'image';
                    const uploadUrl = `${CLOUDINARY_BASE_URL}/${resourceType}/upload`;
                    const response = await fetch(uploadUrl, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.secure_url) {
                        return { url: data.secure_url, resource_type: data.resource_type };
                    } else {
                        throw new Error(data.error?.message || 'Cloudinary upload failed.');
                    }
                } catch (error) {
                    console.error('Error uploading to Cloudinary:', error);
                    throw new Error(`Media upload failed: ${error.message}`);
                }
            }

            // --- Firebase Realtime Database: Add Post ---
            addPostForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    displayAlert(addPostAlert, 'You must be logged in to create a post.');
                    return;
                }

                const title = addPostForm.postTitle.value;
                const content = addPostForm.postContent.value;
                const mediaFile = addPostForm.postMedia.files[0];

                publishPostBtn.disabled = true;
                displayAlert(addPostAlert, 'Publishing post...', 'success');

                let mediaUrl = '';
                let mediaType = '';

                if (mediaFile) {
                    try {
                        const uploadResult = await uploadMediaToCloudinary(mediaFile);
                        mediaUrl = uploadResult.url;
                        mediaType = uploadResult.resource_type;
                    } catch (error) {
                        displayAlert(addPostAlert, error.message);
                        publishPostBtn.disabled = false;
                        return;
                    }
                }

                try {
                    await database.ref('posts').push({
                        title: title,
                        content: content,
                        mediaUrl: mediaUrl,
                        mediaType: mediaType,
                        authorEmail: currentUser.email,
                        authorName: currentUser.displayName || currentUser.email.split('@')[0],
                        authorAvatar: currentUser.photoURL || getDefaultAvatarUrl(currentUser.uid),
                        authorUid: currentUser.uid,
                        timestamp: Date.now()
                    });
                    closeModal(addPostModal);
                    displayAlert(addPostAlert, 'Post published successfully!', 'success');
                    addPostForm.reset();
                } catch (error) {
                    displayAlert(addPostAlert, error.message);
                } finally {
                    publishPostBtn.disabled = false;
                }
            });

            // --- Firebase Realtime Database: Add Story ---
            addStoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    displayAlert(addStoryAlert, 'You must be logged in to add a story.');
                    return;
                }

                const storyFile = addStoryForm.storyMedia.files[0];
                if (!storyFile) {
                    displayAlert(addStoryAlert, 'Please select an image or video for your story.');
                    return;
                }

                publishStoryBtn.disabled = true;
                displayAlert(addStoryAlert, 'Publishing story...', 'success');

                try {
                    const uploadResult = await uploadMediaToCloudinary(storyFile);
                    const storyUrl = uploadResult.url;
                    const storyType = uploadResult.resource_type;

                    await database.ref('stories').push({
                        mediaUrl: storyUrl,
                        mediaType: storyType,
                        authorUid: currentUser.uid,
                        authorName: currentUser.displayName || currentUser.email.split('@')[0],
                        authorAvatar: currentUser.photoURL || getDefaultAvatarUrl(currentUser.uid),
                        timestamp: Date.now()
                    });
                    closeModal(addStoryModal);
                    displayAlert(addStoryAlert, 'Story published successfully!', 'success');
                    addStoryForm.reset();
                } catch (error) {
                    displayAlert(addStoryAlert, error.message);
                } finally {
                    publishStoryBtn.disabled = false;
                }
            });


            // --- Render Post Function (Reusable) ---
            function renderPost(post, containerElement, canEdit = false) {
                const postElement = document.createElement('div');
                postElement.classList.add('post');
                postElement.dataset.postId = post.id;

                let postMediaHtml = '';
                if (post.mediaUrl) {
                    let transformedMediaUrl;
                    if (post.mediaType === 'video') {
                        transformedMediaUrl = post.mediaUrl.replace('/upload/', '/upload/f_auto:video,q_auto,w_600,c_fill/');
                        postMediaHtml = `<video controls muted loop preload="none" poster="${post.mediaUrl.replace('/upload/', '/upload/f_auto,q_auto,w_600,c_fill,pg_1/')}" class="post-video"><source src="${transformedMediaUrl}" type="video/mp4"></video>`;
                    } else {
                        transformedMediaUrl = post.mediaUrl.replace('/upload/', '/upload/f_auto,q_auto,w_600,c_fill/');
                        postMediaHtml = `<img src="${transformedMediaUrl}" alt="${post.title}" class="post-image">`;
                    }
                }

                let followButtonHtml = '';
                if (currentUser && post.authorUid !== currentUser.uid) {
                    const isFollowing = followingList[post.authorUid];
                    const btnClass = isFollowing ? 'unfollow' : '';
                    const btnText = isFollowing ? 'Unfollow' : 'Follow';
                    const icon = isFollowing ? 'fas fa-user-minus' : 'fas fa-user-plus';
                    followButtonHtml = `<button class="follow-btn ${btnClass}" data-author-uid="${post.authorUid}">
                                            <i class="${icon}"></i> ${btnText}
                                        </button>`;
                }

                postElement.innerHTML = `
                    <div class="post-header">
                        <img src="${post.authorAvatar || getDefaultAvatarUrl(post.authorUid || '')}" alt="User" class="post-avatar" data-author-uid="${post.authorUid}">
                        <div class="post-header-info">
                            <div class="post-user" data-author-uid="${post.authorUid}">${post.authorName}</div>
                            <span class="post-time">${timeAgo(post.timestamp)}</span>
                        </div>
                        <div class="post-header-actions">
                            ${followButtonHtml}
                        </div>
                    </div>
                    <div class="post-content">
                        <div class="post-title">${post.title}</div>
                        <div class="post-text">${post.content}</div>
                        ${postMediaHtml}
                    </div>
                    <div class="post-actions">
                        <a href="#" class="post-action"><i class="far fa-heart"></i> Like</a>
                        <a href="#" class="post-action"><i class="far fa-comment"></i> Comment</a>
                        <a href="#" class="post-action"><i class="far fa-share-square"></i> Share</a>
                        ${canEdit ? `<a href="#" class="post-action edit-post-btn" data-post-id="${post.id}"><i class="fas fa-edit"></i> Edit</a>` : ''}
                    </div>
                `;
                containerElement.prepend(postElement);

                // Event listener for post content click (to view detail)
                postElement.querySelector('.post-content').addEventListener('click', (e) => {
                    if (!e.target.closest('video, .post-action')) {
                        openPostDetail(post);
                    }
                });

                // Event listener for post avatar click (to view story)
                postElement.querySelector('.post-avatar').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent post detail from opening
                    const authorUid = e.target.dataset.authorUid;
                    if (authorUid) {
                        openStoryDetailForUser(authorUid); // New function to open story by UID
                    }
                });

                // Event listener for post user name click (to view profile)
                postElement.querySelector('.post-user').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent post detail from opening
                    const authorUid = e.target.dataset.authorUid;
                    if (authorUid) {
                        openUserProfileModal(authorUid); // New function to open user profile
                    }
                });


                if (canEdit) {
                    postElement.querySelector('.edit-post-btn').addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        openEditPostModal(post);
                    });
                }

                const followBtn = postElement.querySelector('.follow-btn');
                if (followBtn) {
                    followBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const authorUidToFollow = e.target.closest('.follow-btn').dataset.authorUid;
                        await toggleFollow(authorUidToFollow);
                    });
                }
            }

            // --- Firebase Realtime Database: Toggle Follow ---
            async function toggleFollow(targetUid) {
                if (!currentUser) {
                    openModal(loginModal);
                    displayAlert(loginAlert, 'Please login to follow users.');
                    return;
                }
                if (targetUid === currentUser.uid) {
                    displayAlert(postContainer, 'You cannot follow yourself.');
                    return;
                }

                const isCurrentlyFollowing = followingList[targetUid];
                const userFollowingRef = database.ref(`userFollowing/${currentUser.uid}/${targetUid}`);

                try {
                    if (isCurrentlyFollowing) {
                        await userFollowingRef.remove();
                        displayAlert(postContainer, `Unfollowed!`, 'success');
                    } else {
                        await userFollowingRef.set(true);
                        displayAlert(postContainer, `Followed!`, 'success');
                    }
                } catch (error) {
                    console.error('Error toggling follow:', error);
                    displayAlert(postContainer, `Failed to toggle follow: ${error.message}`);
                }
            }


            // --- Firebase Realtime Database: Fetch All Posts ---
            function fetchPosts() {
                loadingPosts.style.display = 'block';
                database.ref('posts').orderByChild('timestamp').on('value', (snapshot) => {
                    postContainer.innerHTML = '';
                    loadingPosts.style.display = 'none';

                    if (!snapshot.exists()) {
                        postContainer.innerHTML = '<p class="text-center mt-3">No posts yet. Be the first to share!</p>';
                        return;
                    }

                    const posts = [];
                    snapshot.forEach((childSnapshot) => {
                        posts.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    posts.forEach(post => {
                        renderPost(post, postContainer, false);
                    });
                }, (error) => {
                    console.error("Error fetching posts:", error);
                    loadingPosts.style.display = 'none';
                    postContainer.innerHTML = '<p class="text-center mt-3 alert-message error" style="display:block;">Failed to load posts. Please try again later.</p>';
                });
            }

            // --- Render Story Function ---
            function renderStory(story) {
                const storyElement = document.createElement('div');
                storyElement.classList.add('story');
                storyElement.dataset.storyId = story.id;
                storyElement.dataset.mediaUrl = story.mediaUrl;
                storyElement.dataset.mediaType = story.mediaType;
                storyElement.dataset.authorName = story.authorName;
                storyElement.dataset.authorAvatar = story.authorAvatar;
                storyElement.dataset.timestamp = story.timestamp;
                storyElement.dataset.authorUid = story.authorUid;

                const seenStories = JSON.parse(localStorage.getItem('seenStories') || '{}');
                
                storyElement.innerHTML = `
                    <img src="${story.authorAvatar || getDefaultAvatarUrl(story.authorUid)}" alt="${story.authorName}" class="story-avatar ${seenStories[story.id] ? 'seen' : ''}">
                    <div class="story-username">${story.authorName}</div>
                `;
                // Insert after the "Add Story" button
                storyContainer.insertBefore(storyElement, storyContainer.querySelector('.add-story').nextSibling);

                storyElement.addEventListener('click', () => {
                    openStoryDetail(story); // Open this specific story
                    seenStories[story.id] = true;
                    localStorage.setItem('seenStories', JSON.stringify(seenStories));
                    storyElement.querySelector('.story-avatar').classList.add('seen'); // Mark as seen immediately
                });
            }

            // --- Firebase Realtime Database: Fetch Stories ---
            function fetchStories() {
                loadingStories.style.display = 'block';
                // Clear all dynamic stories, keeping "Add Story" button intact
                Array.from(storyContainer.children).forEach(child => {
                    if (!child.classList.contains('add-story') && !child.classList.contains('text-center')) {
                        child.remove();
                    }
                });

                const now = Date.now();
                const oneDayAgo = now - (24 * 60 * 60 * 1000); // Stories expire after 24 hours

                database.ref('stories').orderByChild('timestamp').startAt(oneDayAgo).on('value', (snapshot) => {
                    // Clear again just in case new stories came in during fetch
                    Array.from(storyContainer.children).forEach(child => {
                        if (!child.classList.contains('add-story') && !child.classList.contains('text-center')) {
                            child.remove();
                        }
                    });
                    loadingStories.style.display = 'none';

                    const stories = [];
                    snapshot.forEach((childSnapshot) => {
                        const story = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        // Filter stories: only current user's or from followed users
                        if (currentUser && (story.authorUid === currentUser.uid || followingList[story.authorUid])) {
                            stories.push(story);
                        }
                    });

                    // Sort by timestamp, newest first
                    stories.sort((a, b) => b.timestamp - a.timestamp);

                    if (stories.length === 0) {
                        if (currentUser && Object.keys(followingList).length > 0) { // If logged in and following, but no stories from them
                            const noStoriesMsg = document.createElement('div');
                            noStoriesMsg.classList.add('story-username');
                            noStoriesMsg.style.width = '200px';
                            noStoriesMsg.style.textAlign = 'center';
                            noStoriesMsg.style.padding = '0 10px';
                            noStoriesMsg.textContent = 'No recent stories from you or followed users.';
                            storyContainer.appendChild(noStoriesMsg);
                        } else if (currentUser) { // Logged in but not following anyone
                            const noStoriesMsg = document.createElement('div');
                            noStoriesMsg.classList.add('story-username');
                            noStoriesMsg.style.width = '200px';
                            noStoriesMsg.style.textAlign = 'center';
                            noStoriesMsg.style.padding = '0 10px';
                            noStoriesMsg.textContent = 'Follow users to see their stories!';
                            storyContainer.appendChild(noStoriesMsg);
                        }
                    } else {
                        stories.forEach(story => renderStory(story));
                    }

                }, (error) => {
                    console.error("Error fetching stories:", error);
                    loadingStories.style.display = 'none';
                    displayAlert(storyContainer, 'Failed to load stories.', 'error');
                });
            }


            // --- Post Detail View ---
            function openPostDetail(post) {
                document.getElementById('detailPostTitle').textContent = post.title;
                const detailContent = document.getElementById('postDetailContent');
                
                let mediaHtml = '';
                if (post.mediaUrl) {
                    let transformedUrl;
                    if (post.mediaType === 'video') {
                        transformedUrl = post.mediaUrl.replace('/upload/', '/upload/f_auto:video,q_auto,w_800,c_limit/');
                        mediaHtml = `<video controls src="${transformedUrl}" class="post-video"></video>`;
                    } else {
                        transformedUrl = post.mediaUrl.replace('/upload/', '/upload/f_auto,q_auto,w_800,c_limit/');
                        mediaHtml = `<img src="${transformedUrl}" alt="${post.title}" class="post-image">`;
                    }
                }

                detailContent.innerHTML = `
                    <div class="post-header">
                        <img src="${post.authorAvatar || getDefaultAvatarUrl(post.authorUid || '')}" alt="User" class="post-avatar" data-author-uid="${post.authorUid}">
                        <div>
                            <div class="post-user" data-author-uid="${post.authorUid}">${post.authorName}</div>
                            <span class="post-time">${timeAgo(post.timestamp)}</span>
                        </div>
                    </div>
                    <div class="post-content">
                        <div class="post-text">${post.content}</div>
                        ${mediaHtml}
                    </div>
                    <div class="post-actions">
                        <a href="#" class="post-action"><i class="far fa-heart"></i> Like</a>
                        <a href="#" class="post-action"><i class="far fa-comment"></i> Comment</a>
                        <a href="#" class="post-action"><i class="far fa-share-square"></i> Share</a>
                    </div>
                `;
                openModal(postDetailModal);

                // Add listeners to elements inside the opened modal
                detailContent.querySelector('.post-avatar').addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeModal(postDetailModal); // Close current modal
                    openStoryDetailForUser(e.target.dataset.authorUid);
                });
                detailContent.querySelector('.post-user').addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeModal(postDetailModal); // Close current modal
                    openUserProfileModal(e.target.dataset.authorUid);
                });
            }

            // --- Story Detail View for a specific Story Object ---
            function openStoryDetail(story) {
                const storyDetailContent = document.getElementById('storyDetailContent');
                storyDetailContent.innerHTML = ''; // Clear previous content

                // Create header for story detail
                const header = document.createElement('div');
                header.classList.add('story-detail-header');
                
                header.innerHTML = `
                    <img src="${story.authorAvatar || getDefaultAvatarUrl(story.authorUid || '')}" alt="User" class="story-avatar">
                    <div class="story-info">
                        <div class="story-username-display">${story.authorName}</div>
                        <span class="story-time-display">${timeAgo(story.timestamp)}</span>
                    </div>
                `;
                storyDetailContent.appendChild(header);

                // Add follow button if not current user's story and logged in
                if (currentUser && story.authorUid !== currentUser.uid) {
                    const followBtn = document.createElement('button');
                    followBtn.classList.add('follow-btn');
                    const isFollowing = followingList[story.authorUid];
                    if (isFollowing) {
                        followBtn.classList.add('unfollow');
                        followBtn.innerHTML = '<i class="fas fa-user-minus"></i> Unfollow';
                    } else {
                        followBtn.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
                    }
                    followBtn.dataset.authorUid = story.authorUid;
                    followBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        await toggleFollow(story.authorUid);
                        // Update button state immediately
                        const newIsFollowing = !isFollowing;
                        if (newIsFollowing) {
                            followBtn.classList.add('unfollow');
                            followBtn.innerHTML = '<i class="fas fa-user-minus"></i> Unfollow';
                        } else {
                            followBtn.classList.remove('unfollow');
                            followBtn.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
                        }
                    });
                    header.appendChild(followBtn);
                }

                // Create media element (image or video)
                let mediaElement;
                if (story.mediaType === 'video') {
                    mediaElement = document.createElement('video');
                    mediaElement.controls = true;
                    mediaElement.autoplay = true;
                    mediaElement.loop = true;
                    mediaElement.muted = true;
                    mediaElement.setAttribute('playsinline', '');
                    mediaElement.src = story.mediaUrl.replace('/upload/', '/upload/f_auto:video,q_auto,c_fit/');
                } else {
                    mediaElement = document.createElement('img');
                    mediaElement.src = story.mediaUrl.replace('/upload/', '/upload/f_auto,q_auto,c_fit/');
                }
                storyDetailContent.appendChild(mediaElement);

                openModal(storyDetailModal);
            }

            // --- Story Detail View for a specific User (shows their latest story) ---
            async function openStoryDetailForUser(uid) {
                const now = Date.now();
                const oneDayAgo = now - (24 * 60 * 60 * 1000);

                const snapshot = await database.ref('stories')
                    .orderByChild('authorUid')
                    .equalTo(uid)
                    .orderByChild('timestamp')
                    .startAt(oneDayAgo)
                    .limitToLast(1) // Get the most recent story
                    .once('value');

                if (snapshot.exists()) {
                    const storyData = snapshot.val();
                    const storyId = Object.keys(storyData)[0];
                    const story = { id: storyId, ...storyData[storyId] };
                    openStoryDetail(story);
                } else {
                    alert('This user has no recent stories.');
                }
            }


            // --- Profile Management ---
            function updateProfileModalUI(user) {
                profileAvatarDisplay.src = user.photoURL || getDefaultAvatarUrl(user.uid);
                profileDisplayName.textContent = user.displayName || 'No Name Set';
                profileEmail.textContent = user.email;
                editDisplayNameInput.value = user.displayName || '';
            }

            changeAvatarBtn.addEventListener('click', () => {
                profileImageUpload.click();
            });

            profileImageUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!currentUser) {
                    displayAlert(profileAlert, 'You must be logged in to change your profile picture.');
                    return;
                }

                displayAlert(profileAlert, 'Uploading new profile picture...', 'success');
                changeAvatarBtn.disabled = true;

                try {
                    const uploadResult = await uploadMediaToCloudinary(file);
                    const newAvatarUrl = uploadResult.url;

                    await currentUser.updateProfile({ photoURL: newAvatarUrl });
                    profileAvatarDisplay.src = newAvatarUrl;
                    displayAlert(profileAlert, 'Profile picture updated successfully!', 'success');
                    await database.ref('userProfiles/' + currentUser.uid).update({ avatarUrl: newAvatarUrl });

                } catch (error) {
                    displayAlert(profileAlert, error.message);
                } finally {
                    changeAvatarBtn.disabled = false;
                    profileImageUpload.value = '';
                }
            });

            editProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return;

                const newDisplayName = editDisplayNameInput.value.trim();
                if (!newDisplayName) {
                    displayAlert(profileAlert, 'Display name cannot be empty.');
                    return;
                }

                updateProfileBtn.disabled = true;
                displayAlert(profileAlert, 'Updating profile...', 'success');

                try {
                    await currentUser.updateProfile({ displayName: newDisplayName });
                    profileDisplayName.textContent = newDisplayName;
                    displayAlert(profileAlert, 'Profile updated successfully!', 'success');
                    await database.ref('userProfiles/' + currentUser.uid).update({ displayName: newDisplayName });

                } catch (error) {
                    displayAlert(profileAlert, error.message);
                } finally {
                    updateProfileBtn.disabled = false;
                }
            });

            profileTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = button.dataset.tab;

                    profileTabButtons.forEach(btn => btn.classList.remove('active'));
                    profileTabContents.forEach(content => content.classList.remove('active'));

                    button.classList.add('active');
                    document.getElementById(targetTabId).classList.add('active');

                    if (targetTabId === 'my-posts-tab' && currentUser) {
                        renderUserPosts(currentUser.uid, myPostsContainer, true); // Render own posts, allow edit
                    }
                });
            });

            // --- Render User's Own Posts (for my profile and other user's profile) ---
            function renderUserPosts(uid, containerElement, canEdit = false) {
                if (!uid) {
                    containerElement.innerHTML = '<p class="text-center mt-3">User not found or not logged in.</p>';
                    return;
                }

                const loadingElement = (containerElement === myPostsContainer) ? loadingMyPosts : loadingUserProfilePosts;
                loadingElement.style.display = 'block';
                containerElement.innerHTML = ''; // Clear previous posts

                database.ref('posts').orderByChild('authorUid').equalTo(uid).on('value', (snapshot) => {
                    containerElement.innerHTML = ''; // Clear again
                    loadingElement.style.display = 'none';

                    if (!snapshot.exists()) {
                        containerElement.innerHTML = '<p class="text-center mt-3">No posts yet from this user.</p>';
                        return;
                    }

                    const userPosts = [];
                    snapshot.forEach((childSnapshot) => {
                        userPosts.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    userPosts.sort((a, b) => b.timestamp - a.timestamp); // Newest first

                    userPosts.forEach(post => {
                        // When rendering on a profile page, we don't want the post itself to open the detail modal.
                        // The 'canEdit' parameter controls the edit button visibility.
                        const postElement = document.createElement('div');
                        postElement.classList.add('post');
                        
                        let postMediaHtml = '';
                        if (post.mediaUrl) {
                            let transformedMediaUrl;
                            if (post.mediaType === 'video') {
                                transformedMediaUrl = post.mediaUrl.replace('/upload/', '/upload/f_auto:video,q_auto,w_600,c_fill/');
                                postMediaHtml = `<video controls muted loop preload="none" poster="${post.mediaUrl.replace('/upload/', '/upload/f_auto,q_auto,w_600,c_fill,pg_1/')}" class="post-video"><source src="${transformedMediaUrl}" type="video/mp4"></video>`;
                            } else {
                                transformedMediaUrl = post.mediaUrl.replace('/upload/', '/upload/f_auto,q_auto,w_600,c_fill/');
                                postMediaHtml = `<img src="${transformedMediaUrl}" alt="${post.title}" class="post-image">`;
                            }
                        }

                        postElement.innerHTML = `
                            <div class="post-header">
                                <img src="${post.authorAvatar || getDefaultAvatarUrl(post.authorUid || '')}" alt="User" class="post-avatar">
                                <div class="post-header-info">
                                    <div class="post-user">${post.authorName}</div>
                                    <span class="post-time">${timeAgo(post.timestamp)}</span>
                                </div>
                            </div>
                            <div class="post-content">
                                <div class="post-title">${post.title}</div>
                                <div class="post-text">${post.content}</div>
                                ${postMediaHtml}
                            </div>
                            <div class="post-actions">
                                <a href="#" class="post-action"><i class="far fa-heart"></i> Like</a>
                                <a href="#" class="post-action"><i class="far fa-comment"></i> Comment</a>
                                <a href="#" class="post-action"><i class="far fa-share-square"></i> Share</a>
                                ${canEdit ? `<a href="#" class="post-action edit-post-btn" data-post-id="${post.id}"><i class="fas fa-edit"></i> Edit</a>` : ''}
                            </div>
                        `;
                        containerElement.appendChild(postElement); // Append to show oldest first in profile context, or adjust to prepend

                        if (canEdit) {
                            postElement.querySelector('.edit-post-btn').addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                openEditPostModal(post);
                            });
                        }
                    });
                }, (error) => {
                    console.error("Error fetching user posts:", error);
                    loadingElement.style.display = 'none';
                    containerElement.innerHTML = '<p class="text-center mt-3 alert-message error" style="display:block;">Failed to load posts.</p>';
                });
            }

            // --- Open Other User's Profile Modal ---
            async function openUserProfileModal(uid) {
                if (!uid) {
                    displayAlert(userProfileAlert, 'User ID is missing.');
                    return;
                }

                // Clear previous data
                userProfileName.textContent = '';
                userProfileAvatar.src = '';
                userProfileDisplayName.textContent = '';
                userProfileEmail.textContent = '';
                userProfilePostsCount.textContent = '0';
                userProfileFollowersCount.textContent = '0';
                userProfileFollowingCount.textContent = '0';
                userProfileFollowBtn.style.display = 'none';
                userProfilePostsContainer.innerHTML = '';
                loadingUserProfilePosts.style.display = 'block';
                displayAlert(userProfileAlert, '', 'success'); // Clear previous alert

                openModal(userProfileModal);

                try {
                    // Fetch user profile data
                    const profileSnapshot = await database.ref('userProfiles/' + uid).once('value');
                    const profile = profileSnapshot.val();
                    if (profile) {
                        userProfileName.textContent = profile.displayName || profile.email.split('@')[0];
                        userProfileAvatar.src = profile.avatarUrl || getDefaultAvatarUrl(uid);
                        userProfileDisplayName.textContent = profile.displayName || profile.email.split('@')[0];
                        userProfileEmail.textContent = profile.email;
                    } else {
                        displayAlert(userProfileAlert, 'User profile not found.', 'error');
                        userProfileName.textContent = 'User Not Found';
                        return; // Stop if profile not found
                    }

                    // Fetch and count their posts
                    const postsSnapshot = await database.ref('posts').orderByChild('authorUid').equalTo(uid).once('value');
                    const postsData = postsSnapshot.val();
                    const posts = postsData ? Object.values(postsData) : [];
                    userProfilePostsCount.textContent = posts.length;
                    
                    // Render their posts in the container
                    loadingUserProfilePosts.style.display = 'none';
                    userProfilePostsContainer.innerHTML = ''; // Clear loading text
                    if (posts.length === 0) {
                        userProfilePostsContainer.innerHTML = '<p class="text-center mt-3">No posts from this user yet.</p>';
                    } else {
                        posts.sort((a,b) => b.timestamp - a.timestamp); // Sort by newest
                        posts.forEach(post => {
                            // CanEdit is false because it's not the current user's editable profile
                            renderPost(post, userProfilePostsContainer, false); 
                            // Override post-content click for these rendered posts to avoid recursive detail modal
                            const renderedPostElement = userProfilePostsContainer.querySelector(`[data-post-id="${post.id}"]`);
                            if (renderedPostElement) {
                                renderedPostElement.querySelector('.post-content').style.cursor = 'default';
                                renderedPostElement.querySelector('.post-content').removeEventListener('click', (e) => openPostDetail(post)); // Remove previous listener
                            }
                        });
                    }

                    // Count who they are following
                    const followingSnapshot = await database.ref(`userFollowing/${uid}`).once('value');
                    userProfileFollowingCount.textContent = followingSnapshot.exists() ? Object.keys(followingSnapshot.val()).length : 0;

                    // Count their followers (this is less efficient)
                    let followerCount = 0;
                    const allFollowingSnapshot = await database.ref('userFollowing').once('value');
                    if (allFollowingSnapshot.exists()) {
                        allFollowingSnapshot.forEach(followerNode => {
                            if (followerNode.child(uid).exists()) { // Check if this follower follows the target UID
                                followerCount++;
                            }
                        });
                    }
                    userProfileFollowersCount.textContent = followerCount;

                    // Show follow/unfollow button if not current user's profile
                    if (currentUser && uid !== currentUser.uid) {
                        userProfileFollowBtn.style.display = 'block';
                        const isFollowing = followingList[uid];
                        userProfileFollowBtn.classList.toggle('unfollow', isFollowing);
                        userProfileFollowBtn.innerHTML = isFollowing ? '<i class="fas fa-user-minus"></i> Unfollow' : '<i class="fas fa-user-plus"></i> Follow';
                        
                        userProfileFollowBtn.onclick = async () => {
                            await toggleFollow(uid);
                            // Update button state immediately after toggle
                            const newIsFollowing = !isFollowing; // Simulate new state
                            userProfileFollowBtn.classList.toggle('unfollow', newIsFollowing);
                            userProfileFollowBtn.innerHTML = newIsFollowing ? '<i class="fas fa-user-minus"></i> Unfollow' : '<i class="fas fa-user-plus"></i> Follow';
                        };
                    } else {
                        userProfileFollowBtn.style.display = 'none';
                    }

                } catch (error) {
                    console.error('Error opening user profile:', error);
                    displayAlert(userProfileAlert, `Failed to load profile: ${error.message}`, 'error');
                }
            }


            // --- Edit Post Functionality ---
            let currentEditingPost = null;

            function openEditPostModal(post) {
                currentEditingPost = post;
                document.getElementById('editPostId').value = post.id;
                document.getElementById('editPostTitle').value = post.title;
                document.getElementById('editPostContent').value = post.content;
                document.getElementById('editPostMedia').value = '';
                document.getElementById('currentPostMediaText').textContent = post.mediaUrl ? `Current media: ${post.mediaType}` : 'No current media.';
                openModal(editPostModal);
            }

            editPostForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !currentEditingPost) {
                    displayAlert(editPostAlert, 'Error: No post selected for editing or not logged in.');
                    return;
                }

                const postId = document.getElementById('editPostId').value;
                const newTitle = document.getElementById('editPostTitle').value;
                const newContent = document.getElementById('editPostContent').value;
                const newMediaFile = document.getElementById('editPostMedia').files[0];

                saveEditPostBtn.disabled = true;
                deletePostBtn.disabled = true;
                displayAlert(editPostAlert, 'Saving changes...', 'success');

                let updatedMediaUrl = currentEditingPost.mediaUrl;
                let updatedMediaType = currentEditingPost.mediaType;

                try {
                    if (newMediaFile) {
                        const uploadResult = await uploadMediaToCloudinary(newMediaFile);
                        updatedMediaUrl = uploadResult.url;
                        updatedMediaType = uploadResult.resource_type;
                    }

                    const updates = {
                        title: newTitle,
                        content: newContent,
                        mediaUrl: updatedMediaUrl,
                        mediaType: updatedMediaType,
                        timestamp: Date.now()
                    };

                    await database.ref('posts/' + postId).update(updates);
                    closeModal(editPostModal);
                    displayAlert(editPostAlert, 'Post updated successfully!', 'success');

                } catch (error) {
                    displayAlert(editPostAlert, error.message);
                } finally {
                    saveEditPostBtn.disabled = false;
                    deletePostBtn.disabled = false;
                }
            });

            deletePostBtn.addEventListener('click', async () => {
                if (!currentUser || !currentEditingPost) return;

                if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                    const postId = document.getElementById('editPostId').value;
                    
                    saveEditPostBtn.disabled = true;
                    deletePostBtn.disabled = true;
                    displayAlert(editPostAlert, 'Deleting post...', 'success');

                    try {
                        await database.ref('posts/' + postId).remove();
                        closeModal(editPostModal);
                        displayAlert(editPostAlert, 'Post deleted successfully!', 'success');
                    } catch (error) {
                        displayAlert(editPostAlert, error.message);
                    } finally {
                        saveEditPostBtn.disabled = false;
                        deletePostBtn.disabled = false;
                    }
                }
            });


            // --- Initial Load ---
            fetchPosts();
        }); // End DOMContentLoaded
    </script>
</body>
</html>