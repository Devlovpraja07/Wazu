<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Group Zikr & DEEN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap'); /* For Arabic text if needed */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0ede7; /* Match Tailwind bg-[#f0ede7] */
        }
         .arabic-text {
             font-family: 'Amiri', serif;
         }
        /* Custom styles for menu */
        .menu {
            position: fixed;
            top: 0;
            right: -250px; /* Initially hidden off-screen */
            width: 250px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.5);
            transition: right 0.3s ease;
            z-index: 100;
            padding-top: 60px; /* Space for fixed header */
            overflow-y: auto; /* Enable scrolling if menu is too long */
        }
        .menu.open {
            right: 0; /* Slide in */
        }
        .menu-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 90;
            display: none; /* Initially hidden */
        }
        .menu-backdrop.visible {
            display: block;
        }
        .menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            color: #333;
            transition: background-color 0.2s ease;
        }
        .menu-item:hover {
            background-color: #f0f0f0;
        }
        .hidden-section {
            display: none;
        }
         .firebaseui-auth-container {
            margin-top: 20px;
        }
        /* Style for active tab */
        .tab-button.active {
            color: #1e9b2f;
            font-weight: 600;
            border-bottom-width: 4px;
            border-bottom-color: #1e9b2f;
        }

        /* Styles for chat area within Zikr card */
        .chat-area {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .chat-messages {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 5px; /* Space for scrollbar */
             display: flex; /* Enable flexbox for message alignment */
            flex-direction: column; /* Stack messages vertically */
        }
        .chat-message {
            margin-bottom: 5px;
            padding: 5px 8px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.9em;
        }
        .message-sent {
            background-color: #dcf8c6; /* Light green */
            align-self: flex-end; /* Align to the right */
            margin-left: auto;
        }
        .message-received {
            background-color: #f1f0f0; /* Light gray */
            align-self: flex-start; /* Align to the left */
            margin-right: auto;
        }
         .chat-input-area {
             display: flex;
             gap: 5px;
         }
         .chat-input-area input {
             flex-grow: 1;
             padding: 8px;
             border: 1px solid #ccc;
             border-radius: 4px;
             outline: none; /* Remove default outline */
              transition: border-color 0.2s;
         }
          .chat-input-area input:focus {
              border-color: #1e9b2f;
          }
         .chat-input-area button {
             padding: 8px 15px;
             background-color: #1e9b2f;
             color: white;
             border: none;
             border-radius: 4px;
             cursor: pointer;
             transition: background-color 0.2s;
         }
         .chat-input-area button:hover {
             background-color: #157f28;
         }
         .chat-header {
             font-weight: bold;
             margin-bottom: 2px; /* Adjust spacing */
             font-size: 0.8em; /* Smaller font for name */
             color: #555;
             display: block; /* Ensure name is on its own line or block */
         }
         .chat-toggle-button {
             background: none;
             border: none;
             color: #1e9b2f;
             cursor: pointer;
             font-size: 0.9em;
             margin-top: 5px;
             text-decoration: underline;
             padding: 0; /* Remove padding */
             display: block; /* Ensure button doesn't interfere with flex layout above */
         }

         /* Styles for Masjid List */
         .masjid-item {
             display: flex;
             align-items: center;
             background-color: white;
             border-radius: 8px;
             padding: 10px;
             margin-bottom: 10px;
             box-shadow: 0 1px 3px rgba(0,0,0,0.1);
             cursor: pointer;
             transition: background-color 0.2s ease;
         }
         .masjid-item:hover {
             background-color: #f9f9f9;
         }
         .masjid-item img {
             width: 60px;
             height: 60px;
             object-fit: cover;
             border-radius: 4px;
             margin-right: 15px;
         }
         .masjid-item-details {
             flex-grow: 1;
         }
         .masjid-item-details h3 {
             font-size: 1.1em;
             font-weight: 500;
             color: #333;
         }
         .masjid-item-details p {
             font-size: 0.9em;
             color: #666;
         }

         /* Styles for Masjid Detail */
         .masjid-detail img {
             max-width: 100%;
             height: auto;
             border-radius: 8px;
             margin-bottom: 15px;
         }
         .masjid-detail h2 {
              font-size: 1.8em;
              font-weight: 600;
              color: #1e9b2f;
              margin-bottom: 10px;
         }
         .masjid-detail p {
             font-size: 1em;
             color: #555;
             margin-bottom: 8px;
         }
          .back-button {
              color: #1e9b2f;
             margin-bottom: 15px;
             display: inline-flex; /* Use inline-flex to align icon and text */
             align-items: center;
             cursor: pointer;
             transition: color 0.2s;
          }
           .back-button:hover {
               color: #157f28;
           }

        /* Styles for DEEN Posts (Cards) */
        .deen-post-card {
             background-color: white;
             border-radius: 8px;
             padding: 15px;
             margin-bottom: 15px;
             box-shadow: 0 1px 3px rgba(0,0,0,0.1);
             cursor: pointer;
             transition: background-color 0.2s ease;
        }
         .deen-post-card:hover {
             background-color: #f9f9f9;
         }
         .deen-post-card h3 {
             font-size: 1.1em;
             font-weight: 500;
             color: #333;
             margin-bottom: 5px;
         }
         .deen-post-card .content-snippet {
             font-size: 0.95em;
             color: #555;
             /* Display first few lines */
             display: -webkit-box;
             -webkit-line-clamp: 3; /* Limit to 3 lines */
             -webkit-box-orient: vertical;
             overflow: hidden;
             text-overflow: ellipsis;
             white-space: normal; /* Ensure wraps */
              margin-bottom: 8px;
         }
          .deen-post-card .post-meta {
              font-size: 0.85em;
              color: #777;
              text-align: right;
          }

        /* Styles for DEEN Post Detail */
        .deen-detail-content {
             background-color: white;
             border-radius: 8px;
             padding: 15px;
             box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
         .deen-detail-content h2 {
             font-size: 1.8em;
             font-weight: 600;
             color: #1e9b2f;
             margin-bottom: 10px;
         }
         .deen-detail-content .full-content {
             font-size: 1em;
             color: #333;
             line-height: 1.6;
             margin-bottom: 15px;
              white-space: pre-wrap; /* Preserve line breaks from input */
         }
          .deen-detail-content .post-meta {
              font-size: 0.9em;
              color: #777;
              text-align: right;
              border-top: 1px solid #eee;
              padding-top: 10px;
          }
         .deen-detail-content .loading-message {
              text-align: center;
              color: #666;
         }

         /* Styles for Create DEEN Post Form */
         #create-deen-post-section textarea {
              width: 100%;
              padding: 10px;
              border: 1px solid #ccc;
              border-radius: 4px;
              min-height: 150px;
              outline: none;
              transition: border-color 0.2s;
         }
          #create-deen-post-section textarea:focus {
               border-color: #1e9b2f;
          }
           #create-deen-post-section button[type="submit"] {
              width: 100%;
               padding: 12px;
               background-color: #1e9b2f;
               color: white;
               border: none;
               border-radius: 4px;
               font-size: 1.1em;
               cursor: pointer;
               transition: background-color 0.2s;
           }
            #create-deen-post-section button[type="submit"]:hover {
                 background-color: #157f28;
            }

    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyD6EXA7D77rQDQEohB52BvTYimFeTEaAho",
            authDomain: "rn-gfx-tool.firebaseapp.com", // Derived from project_id
            databaseURL: "https://rn-gfx-tool-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rn-gfx-tool",
            storageBucket: "rn-gfx-tool.firebasestorage.app"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Get Firebase services
        const auth = firebase.auth();
        const database = firebase.database();
    </script>

</head>
<body class="bg-[#f0ede7]">

<!-- Menu Backdrop -->
<div id="menuBackdrop" class="menu-backdrop"></div>

<!-- Navigation Menu -->
<div id="mainMenu" class="menu">
    <div id="menuHome" class="menu-item">Home (Live Zikr)</div> <!-- Renamed for clarity -->
    <div id="menuZikrHistory" class="menu-item">DEEN</div> <!-- Renamed -->
    <div id="menuCreateDeenPost" class="menu-item hidden">Create DEEN Post</div> <!-- New, initially hidden -->
    <div id="menuMasjidList" class="menu-item">Masjid List</div>
    <div id="menuNimaNews" class="menu-item">Nima News</div>
    <div id="menuAuth" class="menu-item">Login / Create Account</div>
    <div id="menuLogout" class="menu-item hidden">Logout</div>
</div>


<!-- Header -->
<header class="bg-[#1e9b2f] rounded-br-[3.5rem] p-3 flex items-center gap-3 relative z-10">
    <div class="flex-shrink-0 ml-2">
        <img alt="Green book with mosque icon on cover" class="w-12 h-12 rounded-full border-2 border-white" height="48"
             src="https://storage.googleapis.com/a1aa/image/1143f010-e91d-480b-01ec-8db40c987759.jpg" width="48"/>
    </div>
    <div class="flex flex-col text-white flex-grow">
        <h1 class="text-xl font-normal leading-none">GROUP Zikr & DEEN</h1> <!-- Updated App Name -->
        <p id="currentDate" class="text-sm font-normal leading-none">Loading Date...</p>
    </div>
    <div class="ml-auto mr-3">
        <button id="menuButton" aria-label="Menu" class="text-white text-3xl leading-none focus:outline-none">
            <i class="fas fa-bars"></i>
        </button>
    </div>
</header>

<!-- Tabs (Only visible in Zikr/DEEN views) -->
<nav id="mainTabs" class="bg-white flex justify-between border-b-2 border-[#1e9b2f] z-10 relative">
    <button id="tabLiveZikr" class="tab-button active text-[#1e9b2f] font-semibold text-base py-3 px-6 border-b-4 border-[#1e9b2f]">
        Live Zikr
    </button>
    <button id="tabZikrHistory" class="tab-button text-gray-600 font-normal text-base py-3 px-6">
        DEEN
    </button>
</nav>

<!-- Main Content Area -->
<main class="p-4 space-y-4 relative">

    <!-- Live Zikr Section -->
    <section id="live-zikr-section">
        <h2 class="text-center text-2xl font-semibold mb-6 text-[#1e9b2f]">Live Zikr Groups</h2>
        <div id="liveZikrList" class="space-y-4 max-w-md mx-auto">
            <p id="loadingLiveZikr" class="text-center text-gray-600">Loading Live Zikr groups...</p>
        </div>
    </section>

    <!-- DEEN Section (Renamed from Zikr History) -->
    <section id="deen-section" class="hidden-section">
         <h2 class="text-center text-2xl font-semibold mb-6 text-[#1e9b2f]">DEEN Posts (Quran & Islam)</h2>
        <div id="deenPostList" class="space-y-4 max-w-md mx-auto">
             <!-- DEEN post cards will be loaded here -->
            <p id="loadingDeenPosts" class="text-center text-gray-600">Loading DEEN posts...</p>
        </div>
    </section>

    <!-- DEEN Detail Section (New) -->
     <section id="deen-detail-section" class="hidden-section max-w-md mx-auto">
         <button id="backToDeenList" class="back-button">
             <i class="fas fa-arrow-left mr-2"></i> Back to DEEN Posts
         </button>
        <div id="deenDetailContent" class="deen-detail-content mt-4">
            <!-- Full DEEN post content will be loaded here -->
             <p class="loading-message">Loading post...</p>
        </div>
     </section>


    <!-- Authentication Section (Login/Signup Forms) -->
    <section id="auth-section" class="hidden-section max-w-sm mx-auto bg-white rounded-xl p-6 shadow-sm">
        <h2 class="text-center text-2xl font-semibold mb-6 text-[#1e9b2f]">Login or Create Account</h2>

        <!-- Login Form -->
        <div id="loginForm">
            <h3 class="text-xl font-medium mb-4">Login</h3>
            <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 mb-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1e9b2f]">
            <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 mb-4 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#1e9b2f]">
            <button id="loginButton" class="w-full bg-[#1e9b2f] text-white p-3 rounded-md font-semibold hover:bg-green-700 transition">Login</button>
            <p class="text-center mt-4 text-gray-600">Don't have an account? <button id="showSignupForm" class="text-[#1e9b2f] font-semibold focus:outline-none">Create one</button></p>
        </div>

        <!-- Signup Form (Initially hidden) -->
        <div id="signupForm" class="hidden-section">
            <h3 class="text-xl font-medium mb-4">Create Account</h3>
             <input type="text" id="signupName" placeholder="Full Name" class="w-full p-3 mb-3 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#1e9b2f]">
            <input type="email" id="signupEmail" placeholder="Email" class="w-full p-3 mb-3 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#1e9b2f]">
            <input type="password" id="signupPassword" placeholder="Password" class="w-full p-3 mb-4 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#1e9b2f]">
            <button id="signupButton" class="w-full bg-[#1e9b2f] text-white p-3 rounded-md font-semibold hover:bg-green-700 transition">Create Account</button>
             <p class="text-center mt-4 text-gray-600">Already have an account? <button id="showLoginForm" class="text-[#1e9b2f] font-semibold focus:outline-none">Login here</button></p>
        </div>
         <div id="authMessage" class="mt-4 text-center text-sm text-red-600"></div>
    </section>

     <!-- Create Group Section -->
    <section id="create-group-section" class="hidden-section max-w-sm mx-auto bg-white rounded-xl p-6 shadow-sm">
        <h2 class="text-center text-2xl font-semibold mb-6 text-[#1e9b2f]">Create New Zikr Group</h2>
        <form id="createGroupForm" class="space-y-4">
            <div>
                <label for="groupName" class="block text-sm font-medium text-gray-700">Zikr Name</label>
                <input type="text" id="groupName" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#1e9b2f] focus:border-[#1e9b2f]">
            </div>
             <div>
                <label for="groupLocation" class="block text-sm font-medium text-gray-700">Location</label>
                <input type="text" id="groupLocation" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#1e9b2f] focus:border-[#1e9b2f]">
            </div>
             <div>
                <label for="groupTarget" class="block text-sm font-medium text-gray-700">Target Count</label>
                <input type="number" id="groupTarget" required min="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#1e9b2f] focus:border-[#1e9b2f]">
            </div>
            <button type="submit" class="w-full bg-[#1e9b2f] text-white p-3 rounded-md font-semibold hover:bg-green-700 transition">Create Group</button>
        </form>
    </section>

    <!-- Create DEEN Post Section (New) -->
    <section id="create-deen-post-section" class="hidden-section max-w-sm mx-auto bg-white rounded-xl p-6 shadow-sm">
        <h2 class="text-center text-2xl font-semibold mb-6 text-[#1e9b2f]">Create New DEEN Post</h2>
        <form id="createDeenPostForm" class="space-y-4">
            <div>
                <label for="postContent" class="block text-sm font-medium text-gray-700">Post Content (Ayah, Hadith, etc.)</label>
                <textarea id="postContent" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#1e9b2f] focus:border-[#1e9b2f]"></textarea>
            </div>
            <button type="submit" class="w-full bg-[#1e9b2f] text-white p-3 rounded-md font-semibold hover:bg-green-700 transition">Post to DEEN</button>
        </form>
    </section>


    <!-- Masjid List Section -->
    <section id="masjid-list-section" class="hidden-section max-w-md mx-auto">
        <h2 class="text-center text-2xl font-semibold mb-6 text-[#1e9b2f]">Nearby Masjids</h2>
        <div id="masjidListContent" class="space-y-4">
            <p id="loadingMasjids" class="text-center text-gray-600">Loading Masjids...</p>
        </div>
    </section>

    <!-- Masjid Detail Section -->
     <section id="masjid-detail-section" class="hidden-section max-w-md mx-auto bg-white rounded-xl p-6 shadow-sm">
        <button id="backToMasjidList" class="back-button">
             <i class="fas fa-arrow-left mr-2"></i> Back to list
        </button>
        <div id="masjidDetailContent" class="masjid-detail mt-4">
             <p class="loading-message">Loading Masjid details...</p>
        </div>
    </section>


     <!-- Nima News Section -->
    <section id="nima-news-section" class="hidden-section max-w-md mx-auto bg-white rounded-xl p-6 shadow-sm">
        <h2 class="text-center text-2xl font-semibold mb-6 text-[#1e9b2f]">Nima News</h2>
        <p class="text-center text-gray-600">News content will be displayed here.</p>
        <p class="text-center text-sm text-gray-500 mt-4"> (Implementation requires fetching news data, which is not part of this example)</p>
         <!-- Placeholder for news articles -->
        <div id="newsFeed" class="mt-4 space-y-4">
            <div class="border-b pb-3">
                <h3 class="font-semibold text-gray-800">Sample News Headline 1</h3>
                <p class="text-sm text-gray-600">A brief summary of the news article goes here...</p>
            </div>
             <div class="border-b pb-3">
                <h3 class="font-semibold text-gray-800">Sample News Headline 2</h3>
                <p class="text-sm text-gray-600">Another brief summary of the news article...</p>
            </div>
        </div>
    </section>


</main>

<!-- Footer Button (Show only on Live Zikr section if logged in) -->
<footer id="footerButtonArea" class="fixed bottom-0 left-0 w-full bg-[#f0ede7] p-4 flex justify-center z-10">
    <button id="createGroupFooterButton" class="bg-[#1e9b2f] text-white rounded-full px-10 py-3 text-base font-normal hidden" type="button">
        Create New Group Zikr
    </button>
</footer>

<script>
    // DOM Elements
    const menuButton = document.getElementById('menuButton');
    const mainMenu = document.getElementById('mainMenu');
    const menuBackdrop = document.getElementById('menuBackdrop');
    const menuItems = document.querySelectorAll('.menu-item'); // All menu items
    const mainTabs = document.getElementById('mainTabs');
    const tabLiveZikr = document.getElementById('tabLiveZikr');
    const tabDeen = document.getElementById('tabZikrHistory'); // Renamed ID in JS for clarity

    const mainContentSections = document.querySelectorAll('main section'); // All section within main
    const liveZikrSection = document.getElementById('live-zikr-section');
    const deenSection = document.getElementById('deen-section'); // Renamed
    const deenDetailSection = document.getElementById('deen-detail-section'); // New
    const authSection = document.getElementById('auth-section');
    const createGroupSection = document.getElementById('create-group-section');
    const createDeenPostSection = document.getElementById('create-deen-post-section'); // New
    const masjidListSection = document.getElementById('masjid-list-section');
    const masjidDetailSection = document.getElementById('masjid-detail-section');
    const nimaNewsSection = document.getElementById('nima-news-section');

    const liveZikrList = document.getElementById('liveZikrList');
    const deenPostList = document.getElementById('deenPostList'); // Renamed
    const deenDetailContent = document.getElementById('deenDetailContent'); // New
    const masjidListContent = document.getElementById('masjidListContent');
    const masjidDetailContent = document.getElementById('masjidDetailContent');
    const loadingLiveZikr = document.getElementById('loadingLiveZikr');
    const loadingDeenPosts = document.getElementById('loadingDeenPosts'); // Renamed
    const loadingMasjids = document.getElementById('loadingMasjids');
    const backToMasjidListButton = document.getElementById('backToMasjidList');
    const backToDeenListButton = document.getElementById('backToDeenList'); // New

    const footerButtonArea = document.getElementById('footerButtonArea');
    const createGroupFooterButton = document.getElementById('createGroupFooterButton');
    const currentDateElement = document.getElementById('currentDate');

    // Auth Form Elements
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const showSignupFormButton = document.getElementById('showSignupForm');
    const showLoginFormButton = document.getElementById('showLoginForm');
    const loginEmailInput = document.getElementById('loginEmail');
    const loginPasswordInput = document.getElementById('loginPassword');
    const loginButton = document.getElementById('loginButton');
    const signupNameInput = document.getElementById('signupName');
    const signupEmailInput = document.getElementById('signupEmail');
    const signupPasswordInput = document.getElementById('signupPassword');
    const signupButton = document.getElementById('signupButton');
    const authMessageElement = document.getElementById('authMessage');
    const menuAuthItem = document.getElementById('menuAuth');
    const menuLogoutItem = document.getElementById('menuLogout');
    const menuMasjidListItem = document.getElementById('menuMasjidList');
     const menuDeenItem = document.getElementById('menuZikrHistory'); // Renamed ID in JS
     const menuCreateDeenPostItem = document.getElementById('menuCreateDeenPost'); // New

    // Create Group Form Elements
    const createGroupForm = document.getElementById('createGroupForm');
    const groupNameInput = document.getElementById('groupName');
    const groupLocationInput = document.getElementById('groupLocation');
    const groupTargetInput = document.getElementById('groupTarget');

    // Create DEEN Post Form Elements (New)
    const createDeenPostForm = document.getElementById('createDeenPostForm');
    const postContentInput = document.getElementById('postContent');


    let currentUser = null; // To store the logged-in user object from Firebase Auth
    let currentUserName = 'Anonymous'; // To store the user's name from /users

    // --- Helper Functions ---

    // Function to format date
    function formatDate(date) {
        if (!date) return 'N/A';
        const d = new Date(date); // Handles potential ISO strings, timestamps, or Date objects
        // Check if date is valid
        if (isNaN(d.getTime())) {
            console.warn("Invalid date provided:", date);
            return 'Invalid Date';
        }
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return d.toLocaleDateString('en-US', options);
    }

    // Function to format time for chat
    function formatTime(timestamp) {
         if (!timestamp) return '';
         const d = new Date(timestamp);
          if (isNaN(d.getTime())) {
             console.warn("Invalid timestamp provided:", timestamp);
             return '';
         }
         const options = { hour: '2-digit', minute: '2-digit' };
         return d.toLocaleTimeString('en-US', options);
    }


     // Function to show a specific section and hide others
    function showSection(sectionId) {
        mainContentSections.forEach(section => {
            section.classList.add('hidden-section');
        });
        document.getElementById(sectionId).classList.remove('hidden-section');

         // Update tab and footer visibility based on section
        if (sectionId === 'live-zikr-section' || sectionId === 'deen-section') { // Tabs visible for Zikr and DEEN
            mainTabs.classList.remove('hidden-section');
        } else {
            mainTabs.classList.add('hidden-section');
        }

         // Update footer button visibility (only for Create Group on Live Zikr page if logged in)
         if (sectionId === 'live-zikr-section' && currentUser) {
              footerButtonArea.classList.remove('hidden-section');
              createGroupFooterButton.classList.remove('hidden');
         } else {
              footerButtonArea.classList.add('hidden-section');
              createGroupFooterButton.classList.add('hidden');
         }


        // Update tabs active state
        tabLiveZikr.classList.remove('active');
        tabDeen.classList.remove('active');
        if (sectionId === 'live-zikr-section') {
            tabLiveZikr.classList.add('active');
        } else if (sectionId === 'deen-section') {
            tabDeen.classList.add('active');
        }

        // Clear auth message when changing sections
        authMessageElement.textContent = '';
    }

    // Function to toggle menu visibility
    function toggleMenu() {
        mainMenu.classList.toggle('open');
        menuBackdrop.classList.toggle('visible');
    }

    // Close menu when clicking outside or on backdrop
    function closeMenu() {
        mainMenu.classList.remove('open');
        menuBackdrop.classList.remove('visible');
    }

    // --- Authentication Logic ---

    function showAuthMessage(message, isError = true) {
         authMessageElement.textContent = message;
         authMessageElement.className = 'mt-4 text-center text-sm ' + (isError ? 'text-red-600' : 'text-green-600');
    }

    async function handleSignup(event) {
        event.preventDefault();
        const name = signupNameInput.value.trim();
        const email = signupEmailInput.value.trim();
        const password = signupPasswordInput.value.trim();
        authMessageElement.textContent = ''; // Clear previous messages

        if (!name || !email || !password) {
            showAuthMessage('Please fill in all fields.');
            return;
        }
         if (password.length < 6) {
             showAuthMessage('Password should be at least 6 characters.');
             return;
         }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            await database.ref('users/' + user.uid).set({
                name: name,
                email: email,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
            // onAuthStateChanged will handle setting current user and UI updates
            showAuthMessage('Account created successfully! You are now logged in.', false);
             // Clear form
            signupNameInput.value = '';
            signupEmailInput.value = '';
            signupPasswordInput.value = '';

        } catch (error) {
            console.error("Signup Error:", error);
             let errorMessage = error.message;
             if (error.code === 'auth/email-already-in-use') {
                 errorMessage = 'The email address is already in use.';
             } else if (error.code === 'auth/invalid-email') {
                 errorMessage = 'The email address is not valid.';
             } else if (error.code === 'auth/weak-password') {
                errorMessage = 'The password is too weak.';
             }
            showAuthMessage(`Signup Failed: ${errorMessage}`);
        }
    }

    async function handleLogin(event) {
         event.preventDefault();
        const email = loginEmailInput.value.trim();
        const password = loginPasswordInput.value.trim();
         authMessageElement.textContent = ''; // Clear previous messages

         if (!email || !password) {
             showAuthMessage('Please enter email and password.');
             return;
         }

        try {
            await auth.signInWithEmailAndPassword(email, password);
            // onAuthStateChanged will handle setting current user and UI updates
            showAuthMessage('Logged in successfully!', false);
             // Clear form
            loginEmailInput.value = '';
            loginPasswordInput.value = '';
        } catch (error) {
            console.error("Login Error:", error);
             let errorMessage = error.message;
              if (error.code === 'auth/user-not-found') {
                 errorMessage = 'No user found with this email.';
             } else if (error.code === 'auth/wrong-password') {
                 errorMessage = 'Incorrect password.';
             } else if (error.code === 'auth/invalid-credential') {
                 errorMessage = 'Invalid login credentials.';
             }
            showAuthMessage(`Login Failed: ${errorMessage}`);
        }
    }

    async function handleLogout() {
        try {
            // Stop any active group chat listeners before logging out
            for (const groupId in activeGroupListeners) {
                 stopListeningToChat(groupId);
             }

            await auth.signOut();
            // onAuthStateChanged handles UI update and section switch
        } catch (error) {
            console.error("Logout Error:", error);
            alert("Logout Failed: " + error.message);
        }
    }

     // Listen for auth state changes
    auth.onAuthStateChanged(async (user) => {
        currentUser = user;
        authMessageElement.textContent = ''; // Clear auth message on state change

        if (user) {
            // User is signed in
            console.log("User logged in:", user.uid);
             menuAuthItem.classList.add('hidden'); // Hide Login/Create Account menu item
            menuLogoutItem.classList.remove('hidden'); // Show Logout menu item
            menuCreateDeenPostItem.classList.remove('hidden'); // Show Create DEEN Post menu item

            // Fetch user details (name) from database
            try {
                const userSnapshot = await database.ref('users/' + user.uid).once('value');
                if (userSnapshot.exists()) {
                    const userData = userSnapshot.val();
                    currentUserName = userData.name || user.email; // Use name or email if name missing
                    console.log("Current user name:", currentUserName);
                } else {
                    currentUserName = user.email; // Fallback to email
                     console.warn("User data not found in DB for:", user.uid, "Using email as name.");
                }
            } catch (error) {
                 console.error("Error fetching user data:", error);
                 currentUserName = user.email; // Fallback to email on error
            }

            // If currently on auth section, redirect to home (Live Zikr)
            if (!authSection.classList.contains('hidden-section')) {
                 showSection('live-zikr-section'); // Redirect to home/live zikr
            } else {
                 // If already on another page, ensure footer button visibility is correct
                 // showSection already handles this based on current section
                 const currentSection = document.querySelector('main section:not(.hidden-section)').id;
                 showSection(currentSection); // Re-apply visibility logic for current section
            }
             // Refresh live zikr list to update card buttons (Join -> Count/Chat/Audio)
             fetchLiveZikrGroups(); // This listener is always active, but re-render helps UI consistency

        } else {
            // User is signed out
            console.log("User logged out");
            currentUser = null;
            currentUserName = 'Anonymous';
            menuAuthItem.classList.remove('hidden'); // Show Login/Create Account menu item
            menuLogoutItem.classList.add('hidden'); // Hide Logout menu item
            menuCreateDeenPostItem.classList.add('hidden'); // Hide Create DEEN Post menu item

             // If currently on auth-locked sections, redirect to home (Live Zikr)
            const currentSection = document.querySelector('main section:not(.hidden-section)').id;
            if (currentSection === 'create-group-section' || currentSection === 'create-deen-post-section') {
                 showSection('live-zikr-section');
            } else {
                 // If already on another page, ensure footer button visibility is correct
                 showSection(currentSection); // Re-apply visibility logic for current section
            }

             // Refresh live zikr list to update card buttons (show 'Login to Join')
            fetchLiveZikrGroups(); // This listener is always active, but re-render helps UI consistency

        }
    });


    // --- Zikr Group Functionality ---

    // Store active listeners for chat/count to clean up when cards are removed
    const activeGroupListeners = {};

    // Function to create a Zikr card HTML
    function createZikrCardHtml(group) {
        const isJoined = currentUser && group.participants && group.participants[currentUser.uid];
        const countDisplay = group.currentCount || 0; // Default to 0 if null/undefined

        return `
        <section data-group-id="${group.id}" class="bg-white rounded-xl p-4 shadow-sm max-w-md mx-auto group-card">
            <h2 class="text-center text-xl font-serif mb-3">${group.name}</h2>
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start text-sm text-gray-800 mb-3">
                <div class="space-y-0.5 max-w-[60%] break-words pr-2">
                    <p>Name: ${group.creatorName || 'N/A'}</p>
                    <p>Location: ${group.location || 'N/A'}</p>
                    <p>Date: ${group.date ? formatDate(group.date) : 'N/A'}</p>
                </div>
                <div class="text-right space-y-1 text-sm font-semibold max-w-[40%] pl-2">
                    <p>Target : ${group.target || 0}</p>
                    <p>Count : <span id="count-${group.id}">${countDisplay}</span></p>
                </div>
            </div>

            ${currentUser ? ( // Only show interaction buttons if logged in
                 isJoined ?
                 // If joined, show counter, chat, and audio buttons
                 `
                 <div class="mt-4 flex gap-3 justify-end items-center">
                     <button data-group-id="${group.id}" class="bg-[#1e9b2f] text-white rounded-full px-5 py-1.5 flex items-center gap-2 text-sm font-semibold count-button" type="button">
                          +1 Zikr
                         <i class="fas fa-plus"></i>
                      </button>
                     <button data-group-id="${group.id}" class="border border-[#1e9b2f] text-[#1e9b2f] rounded-full px-3 py-1.5 flex items-center gap-2 text-sm font-semibold toggle-chat-button" type="button">
                         <i class="fas fa-comments"></i> Chat
                      </button>
                     <button data-group-id="${group.id}" class="border border-red-500 text-red-500 rounded-full px-3 py-1.5 flex items-center gap-2 text-sm font-semibold audio-call-button" type="button">
                         <i class="fas fa-phone-alt"></i> Audio
                      </button>
                 </div>
                 <!-- Chat Area (initially hidden) -->
                 <div data-group-id="${group.id}" class="chat-area hidden-section">
                     <div class="chat-messages" id="chat-messages-${group.id}">
                         <!-- Messages will be loaded here -->
                          <p class="text-center text-gray-500 text-sm">Loading messages...</p>
                     </div>
                     <div class="chat-input-area">
                          <input type="text" data-group-id="${group.id}" placeholder="Type a message..." class="chat-input flex-grow">
                          <button data-group-id="${group.id}" class="send-chat-button">Send</button>
                     </div>
                 </div>
                 `
                 :
                 // If not joined, show Join and Share buttons
                 `
                 <div class="mt-4 flex gap-3 justify-end items-center">
                     <button data-group-id="${group.id}" class="bg-[#1e9b2f] text-white rounded-full px-5 py-1.5 flex items-center gap-2 text-sm font-semibold join-button" type="button">
                         Join
                        <i class="fas fa-user-friends"></i>
                     </button>
                     <button data-group-id="${group.id}" class="border border-[#1e9b2f] text-[#1e9b2f] rounded-full px-5 py-1.5 flex items-center gap-2 text-sm font-semibold share-button" type="button">
                         <i class="fas fa-share"></i>
                         Share
                     </button>
                 </div>
                 `
             ) :
             // If not logged in, show disabled join and Share buttons
             `
             <div class="mt-4 flex gap-3 justify-end items-center">
                 <button class="bg-gray-400 text-white rounded-full px-5 py-1.5 flex items-center gap-2 text-sm font-semibold" type="button" disabled>
                     Login to Join
                    <i class="fas fa-user-friends"></i>
                 </button>
                 <button data-group-id="${group.id}" class="border border-gray-400 text-gray-600 rounded-full px-5 py-1.5 flex items-center gap-2 text-sm font-semibold share-button" type="button">
                     <i class="fas fa-share"></i>
                     Share
                 </button>
             </div>
             `
             }
        </section>
        `;
    }

    // Attach event listeners using delegation for Zikr card buttons (Join/Count/Chat/Audio/Share)
    function attachZikrCardListeners(container) {
        container.removeEventListener('click', handleZikrCardClick); // Prevent double listeners
        container.addEventListener('click', handleZikrCardClick);

         // Need separate listeners for send button click and Enter key press
         // Delegation is better for dynamically added elements
         container.removeEventListener('click', handleSendButtonClick);
         container.addEventListener('click', handleSendButtonClick);

         container.removeEventListener('keypress', handleChatInputKeypress);
         container.addEventListener('keypress', handleChatInputKeypress);
    }


    // Handle Enter key in chat input
    function handleChatInputKeypress(event) {
        if (event.key === 'Enter') {
            const input = event.target.closest('.chat-input');
            if (input) {
                 const groupId = input.dataset.groupId;
                 const messageText = input.value.trim();
                 if (messageText) { // Only send if message is not empty
                     sendChatMessage(groupId, messageText);
                     input.value = ''; // Clear input
                 }
                 event.preventDefault(); // Prevent default form submission if any
            }
        }
    }

    // Handle Send button click
    function handleSendButtonClick(event) {
         const target = event.target.closest('.send-chat-button');
         if (target) {
             const groupId = target.dataset.groupId;
             const input = target.closest('.chat-input-area').querySelector('.chat-input');
             const messageText = input.value.trim();
             if (messageText) { // Only send if message is not empty
                 sendChatMessage(groupId, messageText);
                 input.value = ''; // Clear input
             }
         }
    }


    async function handleZikrCardClick(event) {
        const target = event.target.closest('button, .toggle-chat-button'); // Include chat toggle button
        if (!target) return;

        const groupId = target.dataset.groupId;
        if (!groupId) return;

        if (target.classList.contains('join-button')) {
             if (!currentUser) {
                 alert('Please login to join a group.');
                 showSection('auth-section');
                 return;
             }
              // Check if already joined (double check UI state)
             const groupRef = database.ref(`groups/${groupId}/participants/${currentUser.uid}`);
              groupRef.once('value', async (snapshot) => {
                  if (snapshot.exists()) {
                      alert('You are already joined in this group.');
                  } else {
                      console.log("Attempting to join group:", groupId);
                       try {
                           await database.ref(`groups/${groupId}/participants/${currentUser.uid}`).set(true);
                           alert('Successfully joined the group!');
                           // UI will update automatically via the listener attached in fetchLiveZikrGroups
                       } catch (error) {
                           console.error("Error joining group:", error);
                           alert("Failed to join group: " + error.message);
                       }
                  }
              });


        } else if (target.classList.contains('count-button')) {
            if (!currentUser) return; // Should be hidden if not logged in, but double check

             // Check if user is actually a participant before allowing count (basic check)
             const groupParticipantsRef = database.ref(`groups/${groupId}/participants/${currentUser.uid}`);
             groupParticipantsRef.once('value', (snapshot) => {
                 if (!snapshot.exists()) {
                     alert('You must join the group to add to the count.');
                     // Optional: refresh the card to show the Join button again
                     fetchLiveZikrGroups();
                     return;
                 }

                 console.log("Incrementing count for group:", groupId);
                  const countRef = database.ref(`groups/${groupId}/currentCount`);

                  // Use a transaction for safe incrementing
                  countRef.transaction((currentCount) => {
                      return (currentCount || 0) + 1;
                  }, (error, committed, snapshot) => {
                      if (error) {
                          console.error("Transaction failed:", error);
                          // alert("Failed to update count: " + error.message); // Avoid too many alerts
                      } else if (!committed) {
                           console.log("Transaction aborted.");
                      } else {
                          console.log("Count updated successfully:", snapshot.val());
                      }
                  });
             });


        } else if (target.classList.contains('share-button')) {
            alert(`Share feature for group ID: ${groupId} (Not fully implemented)`);
            // Web Share API or copy link implementation here
        } else if (target.classList.contains('toggle-chat-button')) {
             // Toggle chat area visibility
             const chatArea = document.querySelector(`.group-card[data-group-id="${groupId}"] .chat-area`);
             if (chatArea) {
                 chatArea.classList.toggle('hidden-section');
                 if (!chatArea.classList.contains('hidden-section')) {
                      // Load chat messages when chat is opened
                     loadChatMessages(groupId);
                 } else {
                     // Stop listening when chat is closed (optional but good practice)
                     stopListeningToChat(groupId);
                     // Clear messages when closing
                      const messagesContainer = document.getElementById(`chat-messages-${groupId}`);
                     if(messagesContainer) messagesContainer.innerHTML = '';
                 }
             }
        } else if (target.classList.contains('audio-call-button')) {
            // Check if user is a participant before allowing call (basic check)
             const groupParticipantsRef = database.ref(`groups/${groupId}/participants/${currentUser.uid}`);
             groupParticipantsRef.once('value', (snapshot) => {
                 if (!snapshot.exists()) {
                      alert('You must join the group to start an audio call.');
                      return;
                  }
                alert(`Audio Call feature for group ID: ${groupId}\n\nNote: Full audio/video calls require WebRTC and a signaling server (Firebase can be used for signaling, but not the media stream itself). This is a complex feature not fully implemented in this example.`);
                 // WebRTC signaling logic would start here
             });
        }
    }

    // --- Chat Functionality ---

    function loadChatMessages(groupId) {
        const messagesContainer = document.getElementById(`chat-messages-${groupId}`);
        if (!messagesContainer) return;

        // Clear previous messages and show loading
        messagesContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">Loading messages...</p>';
        messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom

        // Stop any existing listener for this group's chat before starting a new one
        stopListeningToChat(groupId);

        // Listen for new messages being added
        const chatRef = database.ref(`group_messages/${groupId}`).orderByChild('timestamp').limitToLast(50); // Limit messages
        const listener = chatRef.on('child_added', (snapshot) => {
             // Remove initial loading message if present
             if (messagesContainer.querySelector('.loading-message')) {
                 messagesContainer.innerHTML = '';
             }
             const message = snapshot.val();
             displayMessage(messagesContainer, message, currentUser.uid);
        }, (error) => {
             console.error("Error loading chat messages:", error);
             messagesContainer.innerHTML = '<p class="text-center text-red-600 text-sm">Error loading messages.</p>';
        });

        // Store the listener so it can be removed later
        activeGroupListeners[groupId] = listener;
        console.log("Started listening to chat for group:", groupId);
    }

    function stopListeningToChat(groupId) {
         if (activeGroupListeners[groupId]) {
             const chatRef = database.ref(`group_messages/${groupId}`);
             chatRef.off('child_added', activeGroupListeners[groupId]);
             delete activeGroupListeners[groupId];
             console.log("Stopped listening to chat for group:", groupId);
         }
    }

    function displayMessage(container, message, currentUserId) {
         // Check if the message is valid
        if (!message || !message.text) {
            console.warn("Skipping invalid message:", message);
            return;
        }

        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message');

        const isSentByCurrentUser = message.senderId === currentUserId;
        messageElement.classList.add(isSentByCurrentUser ? 'message-sent' : 'message-received');

        const senderName = message.senderName || 'Anonymous';
        const messageText = message.text;
        const timestamp = message.timestamp;


        if (!isSentByCurrentUser) {
            const senderSpan = document.createElement('span');
            senderSpan.classList.add('chat-header');
            senderSpan.textContent = senderName; // Just name, no colon
             messageElement.appendChild(senderSpan);
        }

         const textSpan = document.createElement('span'); // Span for the message text itself
         textSpan.textContent = messageText;
         messageElement.appendChild(textSpan);

        // Add timestamp below the message text
         const timeSpan = document.createElement('span');
         timeSpan.classList.add('text-xs', 'text-gray-500', isSentByCurrentUser ? 'block text-right' : 'block text-left'); // Tailwind classes
         timeSpan.textContent = formatTime(timestamp);
         messageElement.appendChild(timeSpan);


        container.appendChild(messageElement);

        // Scroll to the bottom of the chat only if the user is near the bottom already
        const isAtBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 50; // 50px tolerance
        if (isAtBottom) {
            container.scrollTop = container.scrollHeight;
        }
    }

    function sendChatMessage(groupId, messageText) {
        if (!currentUser || !currentUserName || !messageText) {
            console.warn("Cannot send message: Not logged in, name missing, or empty message.");
            return;
        }

        // Basic check if user is a participant before sending message
         const groupParticipantsRef = database.ref(`groups/${groupId}/participants/${currentUser.uid}`);
         groupParticipantsRef.once('value', (snapshot) => {
             if (!snapshot.exists()) {
                 alert('You must join the group to send messages.');
                 // Optional: refresh the card to hide chat if somehow visible
                 fetchLiveZikrGroups();
                 return;
             }

             const message = {
                 senderId: currentUser.uid,
                 senderName: currentUserName,
                 text: messageText,
                 timestamp: firebase.database.ServerValue.TIMESTAMP // Use server timestamp
             };

             database.ref(`group_messages/${groupId}`).push(message)
                 .then(() => {
                     console.log("Message sent to group:", groupId);
                     // UI update handled by the 'child_added' listener
                 })
                 .catch(error => {
                     console.error("Error sending message:", error);
                     alert("Failed to send message: " + error.message);
                 });
         });
    }


    // Function to fetch Live Zikr groups
    function fetchLiveZikrGroups() {
        console.log("Fetching Live Zikr groups...");
        liveZikrList.innerHTML = ''; // Clear current list
        loadingLiveZikr.classList.remove('hidden-section');

        // Stop any chat listeners from previously displayed groups
        // No need to stop listeners here if fetchLiveZikrGroups is always active listener
        // But if it were 'once', we would stop listeners here.
        // The '.on' listener manages updates internally, so clearing and re-adding might cause flicker.
        // A better pattern for '.on' might be to update/remove individual cards instead of clearing the whole list.
        // For simplicity in this example, we'll keep clearing and re-adding, but be aware of flicker.
        // Stop chat listeners attached to *cards* that might be removed:
         for (const groupId in activeGroupListeners) {
            stopListeningToChat(groupId);
        }


        const groupsRef = database.ref('groups').orderByChild('createdAt'); // Or orderByChild('status').equalTo('active')

        // Use 'value' listener for real-time updates on the group list itself
        // This listener replaces the entire list content whenever data changes.
        groupsRef.on('value', (snapshot) => {
            loadingLiveZikr.classList.add('hidden-section'); // Hide loading message
            liveZikrList.innerHTML = ''; // Clear list before adding fresh data

            const groups = [];
            if (snapshot.exists()) {
                 snapshot.forEach(childSnapshot => {
                     const group = childSnapshot.val();
                     group.id = childSnapshot.key; // Add group ID to the object
                     groups.push(group);
                 });
            }

            // Reverse to show latest first
            groups.reverse();

            if (groups.length === 0) {
                 liveZikrList.innerHTML = '<p class="text-center text-gray-600">No Live Zikr groups found.</p>';
            } else {
                 groups.forEach(group => {
                     const cardHtml = createZikrCardHtml(group);
                     liveZikrList.insertAdjacentHTML('beforeend', cardHtml);
                 });
                 // Re-attach listeners to the updated list container
                 attachZikrCardListeners(liveZikrList);
            }
             console.log("Live Zikr groups fetched:", groups.length);
        }, (error) => {
            console.error("Error fetching Live Zikr groups:", error);
            loadingLiveZikr.classList.add('hidden-section');
            liveZikrList.innerHTML = '<p class="text-center text-red-600">Error loading groups.</p>';
        });
    }

    // Function to create a new Zikr Group
    async function handleCreateGroup(event) {
         event.preventDefault();

         if (!currentUser) {
             alert('You must be logged in to create a group.');
             return; // Should be prevented by UI too, but good double check
         }

         const name = groupNameInput.value.trim();
         const location = groupLocationInput.value.trim();
         const target = parseInt(groupTargetInput.value.trim(), 10);

         if (!name || !location || isNaN(target) || target <= 0) {
             alert('Please fill in all fields correctly. Target must be a positive number.');
             return;
         }

        try {
             const creatorName = currentUserName; // Use the currentUserName

             const newGroup = {
                 name: name,
                 creatorId: currentUser.uid,
                 creatorName: creatorName,
                 location: location,
                 date: new Date().toISOString().split('T')[0], // Store today's date (YYYY-MM-DD)
                 target: target,
                 currentCount: 0,
                 createdAt: firebase.database.ServerValue.TIMESTAMP, // Server timestamp
                 participants: { // Initialize with creator as participant
                    [currentUser.uid]: true
                 },
                 status: 'active'
             };

             const newGroupRef = await database.ref('groups').push(newGroup);
             console.log("New group created with key:", newGroupRef.key);

             alert('Group created successfully!');
             createGroupForm.reset();
             showSection('live-zikr-section');
             // fetchLiveZikrGroups() listener will pick up the new group automatically
         } catch (error) {
             console.error("Error creating group:", error);
             alert("Failed to create group: " + error.message);
         }
    }


    // --- DEEN Posts Functionality (Renamed from Zikr History) ---

    function createDeenPostCardHtml(post) {
         // Truncate content for card view
         const snippet = post.content ? post.content.substring(0, 150) + (post.content.length > 150 ? '...' : '') : '';
         const date = post.createdAt ? formatDate(new Date(post.createdAt)) : 'N/A Date';

        return `
            <div class="deen-post-card" data-post-id="${post.id}">
                 <!-- Optional title if you add it to data -->
                 <!-- <h3>${post.title || 'Untitled Post'}</h3> -->
                 <div class="content-snippet">${snippet}</div>
                 <div class="post-meta">Posted by ${post.creatorName || 'Anonymous'} on ${date}</div>
            </div>
        `;
    }

    function fetchDeenPosts() {
         console.log("Fetching DEEN posts...");
         deenPostList.innerHTML = ''; // Clear current list
         loadingDeenPosts.classList.remove('hidden-section');
         deenDetailContent.innerHTML = ''; // Clear detail view if anything was there

         const postsRef = database.ref('deen_posts').orderByChild('createdAt');

         // Use 'value' listener for real-time updates on the post list
         postsRef.on('value', (snapshot) => {
             loadingDeenPosts.classList.add('hidden-section'); // Hide loading message
             deenPostList.innerHTML = ''; // Clear list before adding fresh data

             const posts = [];
             if (snapshot.exists()) {
                 snapshot.forEach(childSnapshot => {
                     const post = childSnapshot.val();
                     post.id = childSnapshot.key; // Add post ID
                     posts.push(post);
                 });
             }


             // Reverse to show latest first
             posts.reverse();

             if (posts.length === 0) {
                  deenPostList.innerHTML = '<p class="text-center text-gray-600">No DEEN posts found.</p>';
             } else {
                  posts.forEach(post => {
                      const cardHtml = createDeenPostCardHtml(post);
                      deenPostList.insertAdjacentHTML('beforeend', cardHtml);
                  });
                  // Attach listeners to post cards
                   attachDeenPostListListeners();
             }
              console.log("DEEN posts fetched:", posts.length);
         }, (error) => {
             console.error("Error fetching DEEN posts:", error);
             loadingDeenPosts.classList.add('hidden-section');
             deenPostList.innerHTML = '<p class="text-center text-red-600">Error loading posts.</p>';
         });
    }

    function attachDeenPostListListeners() {
         // Use delegation on the list container
         deenPostList.removeEventListener('click', handleDeenPostClick);
         deenPostList.addEventListener('click', handleDeenPostClick);
    }

    function handleDeenPostClick(event) {
        const targetItem = event.target.closest('.deen-post-card');
        if (targetItem) {
            const postId = targetItem.dataset.postId;
            if (postId) {
                showDeenPostDetail(postId);
            }
        }
    }

    function showDeenPostDetail(postId) {
         showSection('deen-detail-section'); // Switch section first
         deenDetailContent.innerHTML = '<p class="loading-message">Loading post...</p>'; // Show loading in detail area

         // Fetch the specific post details
         database.ref(`deen_posts/${postId}`).once('value', (snapshot) => {
             if (snapshot.exists()) {
                 const post = snapshot.val();
                 const date = post.createdAt ? formatDate(new Date(post.createdAt)) : 'N/A Date';
                 deenDetailContent.innerHTML = `
                     <h2>DEEN Post</h2> <!-- Can add post.title if exists -->
                     <div class="full-content arabic-text">${post.content || 'No content available'}</div>
                     <div class="post-meta">Posted by ${post.creatorName || 'Anonymous'} on ${date}</div>
                 `;
             } else {
                 deenDetailContent.innerHTML = '<p class="text-center text-red-600">Post not found.</p>';
             }
         }, (error) => {
              console.error("Error fetching DEEN post detail:", error);
              deenDetailContent.innerHTML = '<p class="text-center text-red-600">Error loading post details.</p>';
         });
    }

     async function handleCreateDeenPost(event) {
         event.preventDefault();

         if (!currentUser) {
             alert('You must be logged in to create a post.');
             return; // Should be prevented by UI too
         }

         const content = postContentInput.value.trim();

         if (!content) {
             alert('Post content cannot be empty.');
             return;
         }

         try {
              const creatorName = currentUserName; // Use the currentUserName

              const newPost = {
                 content: content,
                 creatorId: currentUser.uid,
                 creatorName: creatorName,
                 createdAt: firebase.database.ServerValue.TIMESTAMP // Server timestamp
             };

             await database.ref('deen_posts').push(newPost);
             console.log("New DEEN post created.");

             alert('Post created successfully!');
             createDeenPostForm.reset();
             showSection('deen-section'); // Go back to DEEN list
             // fetchDeenPosts() listener will pick up the new post automatically
         } catch (error) {
             console.error("Error creating DEEN post:", error);
             alert("Failed to create post: " + error.message);
         }
     }


    // --- Masjid Functionality ---

    function createMasjidListItemHtml(masjid) {
        return `
            <div class="masjid-item" data-masjid-id="${masjid.id}">
                <img src="${masjid.imageUrl || 'https://via.placeholder.com/100?text=No+Image'}" alt="${masjid.name || 'Masjid'} Image"/>
                <div class="masjid-item-details">
                    <h3>${masjid.name || 'Unnamed Masjid'}</h3>
                    <p>${masjid.address || 'No Address'}</p>
                </div>
            </div>
        `;
    }

    function fetchMasjidList() {
         console.log("Fetching Masjid list...");
         masjidListContent.innerHTML = ''; // Clear current list
         loadingMasjids.classList.remove('hidden-section');
         masjidDetailContent.innerHTML = ''; // Clear detail view

         const masjidsRef = database.ref('masjids').orderByChild('name');

         masjidsRef.once('value', (snapshot) => { // Use 'once' for list that doesn't change often
             loadingMasjids.classList.add('hidden-section'); // Hide loading message
             masjidListContent.innerHTML = ''; // Clear list again

             const masjids = [];
             if (snapshot.exists()) {
                 snapshot.forEach(childSnapshot => {
                     const masjid = childSnapshot.val();
                     masjid.id = childSnapshot.key; // Add masjid ID
                      // Filter out any invalid entries if necessary
                      if (masjid && masjid.name) {
                        masjids.push(masjid);
                      }
                 });
             }


             if (masjids.length === 0) {
                  masjidListContent.innerHTML = '<p class="text-center text-gray-600">No Masjids found in the database.</p>';
             } else {
                  masjids.forEach(masjid => {
                      const itemHtml = createMasjidListItemHtml(masjid);
                      masjidListContent.insertAdjacentHTML('beforeend', itemHtml);
                  });
                  // Attach listeners to masjid items
                   attachMasjidListListeners();
             }
              console.log("Masjids fetched:", masjids.length);
         }, (error) => {
             console.error("Error fetching Masjids:", error);
             loadingMasjids.classList.add('hidden-section');
             masjidListContent.innerHTML = '<p class="text-center text-red-600">Error loading Masjids.</p>';
         });
    }

    function attachMasjidListListeners() {
         // Use delegation on the list container
         masjidListContent.removeEventListener('click', handleMasjidItemClick);
         masjidListContent.addEventListener('click', handleMasjidItemClick);
    }

    function handleMasjidItemClick(event) {
        const targetItem = event.target.closest('.masjid-item');
        if (targetItem) {
            const masjidId = targetItem.dataset.masjidId;
            if (masjidId) {
                showMasjidDetail(masjidId);
            }
        }
    }

    function showMasjidDetail(masjidId) {
         showSection('masjid-detail-section'); // Switch section first
         masjidDetailContent.innerHTML = '<p class="loading-message">Loading Masjid details...</p>'; // Show loading

         // Fetch the specific masjid details
         database.ref(`masjids/${masjidId}`).once('value', (snapshot) => {
             if (snapshot.exists()) {
                 const masjid = snapshot.val();
                 masjidDetailContent.innerHTML = `
                     ${masjid.imageUrl ? `<img src="${masjid.imageUrl}" alt="${masjid.name || 'Masjid'} Image" />` : ''}
                     <h2>${masjid.name || 'Unnamed Masjid'}</h2>
                     <p><strong>Address:</strong> ${masjid.address || 'No address available'}</p>
                      <!-- Add more details here if available in data -->
                 `;
             } else {
                 masjidDetailContent.innerHTML = '<p class="text-center text-red-600">Masjid details not found.</p>';
             }
         }, (error) => {
              console.error("Error fetching Masjid detail:", error);
              masjidDetailContent.innerHTML = '<p class="text-center text-red-600">Error loading Masjid details.</p>';
         });
    }


    // --- Event Listeners ---

    // Menu button toggle
    menuButton.addEventListener('click', toggleMenu);
    // Close menu on backdrop click
    menuBackdrop.addEventListener('click', closeMenu);
    // Close menu on menu item click and navigate
    menuItems.forEach(item => {
        item.addEventListener('click', () => {
            closeMenu();
            authMessageElement.textContent = ''; // Clear auth messages when changing section

            if (item.id === 'menuHome') { // Home is Live Zikr
                showSection('live-zikr-section');
                 fetchLiveZikrGroups();

            } else if (item.id === 'menuZikrHistory') { // This is now DEEN
                showSection('deen-section');
                 fetchDeenPosts();

            } else if (item.id === 'menuCreateDeenPost') { // New create DEEN Post
                 if (currentUser) { // Only show if logged in
                     showSection('create-deen-post-section');
                 } else {
                     alert('Please login to create a DEEN post.');
                     showSection('auth-section'); // Redirect to login
                 }

            } else if (item.id === 'menuMasjidList') {
                 showSection('masjid-list-section');
                 fetchMasjidList(); // Load masjid data

            } else if (item.id === 'menuNimaNews') {
                showSection('nima-news-section');
                 // Nima News content loading logic here
            } else if (item.id === 'menuAuth') {
                 if (!currentUser) {
                    showSection('auth-section');
                     loginForm.classList.remove('hidden-section');
                     signupForm.classList.add('hidden-section');
                 }
            } else if (item.id === 'menuLogout') {
                 handleLogout();
            }
        });
    });

    // Tab button switching (Live Zikr and DEEN)
    tabLiveZikr.addEventListener('click', () => {
         showSection('live-zikr-section');
         // fetchLiveZikrGroups(); // Listener is always active
    });
    tabDeen.addEventListener('click', () => { // Listener for DEEN tab
        showSection('deen-section');
         fetchDeenPosts();
    });


    // Auth form toggle buttons
    showSignupFormButton.addEventListener('click', () => {
        loginForm.classList.add('hidden-section');
        signupForm.classList.remove('hidden-section');
         authMessageElement.textContent = ''; // Clear message on form switch
    });
    showLoginFormButton.addEventListener('click', () => {
        signupForm.classList.add('hidden-section');
        loginForm.classList.remove('hidden-section');
         authMessageElement.textContent = ''; // Clear message on form switch
    });

    // Auth form submissions
    loginForm.addEventListener('submit', handleLogin);
    signupForm.addEventListener('submit', handleSignup);


     // Create Group footer button click
    createGroupFooterButton.addEventListener('click', () => {
        if (currentUser) {
             showSection('create-group-section');
        } else {
             alert('Please login to create a group.');
             showSection('auth-section');
        }
    });

     // Create Group form submission
     createGroupForm.addEventListener('submit', handleCreateGroup);

     // Create DEEN Post form submission (New)
     createDeenPostForm.addEventListener('submit', handleCreateDeenPost);


     // Back button on Masjid Detail page
     backToMasjidListButton.addEventListener('click', () => {
         showSection('masjid-list-section');
         // No need to re-fetch masjid list, it should still be there
     });

     // Back button on DEEN Detail page (New)
      backToDeenListButton.addEventListener('click', () => {
          showSection('deen-section');
          // No need to re-fetch deen posts, the listener is active
      });


    // --- Initial Setup ---

    // Set current date in header
    function updateHeaderDate() {
        const today = new Date();
        currentDateElement.textContent = formatDate(today);
        // Note: Hijri date requires external library or complex calculation.
    }
    updateHeaderDate();

    // Initialize view: Firebase auth listener handles the initial section display.
    // It calls fetchLiveZikrGroups() whether logged in or out to show the initial list.
    // We don't call fetchLiveZikrGroups() directly here because the onAuthStateChanged
    // listener will call it after determining the auth state. This avoids redundant fetches.


</script>

</body>
</html>